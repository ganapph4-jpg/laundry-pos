<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAMA'S LOVE LAUNDRY POS</title>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/fromNow.js"></script>
  <script>
    dayjs.extend(dayjs_plugin_utc);
    dayjs.extend(dayjs_plugin_timezone);
    dayjs.extend(dayjs_plugin_isBetween);
    dayjs.extend(dayjs_plugin_fromNow);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/localforage/dist/localforage.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- ADDED: SheetJS library for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- ADDED: QR Code generation library for receipts -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ### NEW ### Add Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    @media print {
      body * { visibility: hidden; }
      #receiptSection, #receiptSection * { visibility: visible; }
      #receiptSection { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
      .receipt-content { width: 57mm; font-family: monospace; font-size: 10px; line-height: 1.2; color: #000; background: #fff; } /* Adjusted line-height */
    }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; }
    .inline-loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 2rem auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #settings-panel { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
    #settings-panel.open { transform: translateX(0); }
    .swal2-popup { font-size: 0.9rem !important; }
    .swal2-input { font-size: 1rem !important; }
    .main-view { display: none; }
    .main-view.active { display: block; }
    .settings-tab-button.active { border-color: #3b82f6; color: #3b82f6; }
    #swal-change-display { margin-top: 1rem; padding: 0.5rem; border-radius: 0.25rem; font-weight: bold; text-align: center; }
    #swal-change-display.positive { color: #065f46; }
    #swal-change-display.negative { color: #991b1b; }

    /* --- Styles for Bluetooth Printer --- */
    #pickup-connect-printer-btn.disconnected { color: #ef4444; }
    #pickup-connect-printer-btn.connecting { color: #f59e0b; }
    #pickup-connect-printer-btn.connected { color: #22c55e; }
    #swal-auto-print-toggle:checked ~ .dot { transform: translateX(100%); }
    #swal-auto-print-toggle:checked ~ .block { background-color: #0891b2; }
    .view-toggle-btn.active { background-color: #3b82f6; color: white; }
    .view-toggle-btn { background-color: #e5e7eb; color: #374151; }
    .pickup-filter-btn.active { background-color: #6d28d9; color: white; }
    .pickup-filter-btn { background-color: #e5e7eb; color: #374151; }

    /* NEW: Password strength indicator */
    #password-strength-indicator { height: 5px; border-radius: 5px; transition: width 0.3s, background-color 0.3s; }
    .strength-weak { background-color: #ef4444; width: 25%; }
    .strength-medium { background-color: #f59e0b; width: 60%; }
    .strength-strong { background-color: #22c55e; width: 100%; }

    /* NEW: General improvements for tablet touch behavior */
    body {
      touch-action: manipulation; /* Prevents double-tap zoom for better touch responsiveness */
    }

    /* ### NEW ### Hide main content before login */
    #main-app-container.hidden {
        display: none;
    }
  </style>
</head>
<body class="bg-gray-100 p-4 text-base"> <!-- CHANGED: text-sm to text-base for better readability on tablets -->

  <!-- ### NEW ### Main container to hide content before login -->
  <div id="main-app-container" class="hidden">
    <div class="max-w-4xl mx-auto">
        <!-- Shared Header & Navigation -->
        <div class="flex justify-between items-center mb-4">
        <h1 id="header-title" class="text-xl font-bold text-center flex-grow">LAUNDRY POS</h1>
        <div class="flex items-center space-x-2">
            <button onclick="showView('pos-view')" id="to-pos-btn" title="Go to POS" class="text-gray-600 hover:text-blue-600 p-2 hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H7a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            </button>
            <button onclick="showView('pickup-view')" id="to-pickup-btn" title="Manage Pickups" class="text-gray-600 hover:text-blue-600 p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </button>
            <button onclick="openSettingsWithPassword()" title="Owner Settings" class="text-gray-600 hover:text-blue-600 p-2 ml-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
        </div>
        </div>
    </div>

    <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-5 rounded-lg shadow-xl flex items-center">
            <div class="loader"></div>
            <p id="loadingIndicatorText" class="text-gray-800 text-lg ml-4">Processing...</p>
        </div>
    </div>

    <!-- POS VIEW -->
    <div id="pos-view" class="main-view active max-w-2xl mx-auto"> <!-- CHANGED: max-w-xl to max-w-2xl for better tablet layout -->
        <div class="bg-white p-4 rounded shadow mb-4">
        <h2 class="text-lg font-bold mb-2 text-blue-700">Create New Order</h2>
        <div class="relative">
            <!-- MODIFIED: oninput removed for debouncing -->
            <input id="name" type="text" placeholder="Customer Name" class="border p-2 w-full mb-2" />
            <input id="phone" type="text" placeholder="Phone Number (Optional)" class="border p-2 w-full mb-2" />
            <div id="customer-search-results" class="absolute left-0 right-0 z-10 bg-white border rounded-md shadow-lg hidden max-h-48 overflow-y-auto"></div>
        </div>
        <label class="block font-semibold">Payment Type:</label>
        <select id="paymentType" class="border p-2 w-full mb-2">
            <option value="collection">For Collection</option>
            <option value="paid">Fully Paid</option>
            <option value="down_payment">Down Payment</option> <!-- NEW: Down Payment Option -->
        </select>

        <!-- ADDED: Optional Notes Field -->
        <input id="orderNotes" type="text" placeholder="Optional Notes (e.g., Makapal, Handle with care)" class="border p-2 w-full mb-2" />

        <div id="service-buttons-container" class="mt-4">
            <div id="service-loader" class="inline-loader"></div>
        </div>
        <div id="cart" class="mb-2 mt-4"></div>
        <p class="font-bold">Total: ₱<span id="total">0</span></p>
        <button id="submitOrderBtn" onclick="submitOrder()" class="bg-blue-500 text-white px-4 py-2 rounded mt-2 hover:bg-blue-600 transition w-full">Submit Order</button>
        <button onclick="confirmClearForm()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded mt-2 hover:bg-gray-300 transition w-full">Clear Form</button>
        </div>
        <div id="find-order-section" class="bg-white p-4 rounded shadow mt-4">
        <h2 class="text-lg font-bold mb-2 text-indigo-700">Find a Specific Order</h2>
        <div class="flex gap-2 mt-1">
            <input type="text" id="searchInput" oninput="searchTransactions()" placeholder="Search by OR #, Phone, or Name" class="border p-2 w-full" />
            <!-- MODIFIED SEARCH BUTTON HERE -->
            <button onclick="openSearchPopup()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
            <button onclick="clearSearch()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Clear</button>
        </div>
        <div id="searchResults" class="mt-2"></div>
        </div>
    </div>

    <!-- PICKUP MANAGEMENT VIEW -->
    <div id="pickup-view" class="main-view max-w-4xl mx-auto">
        <div class="mb-6">
            <div class="flex justify-between items-start flex-wrap gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Pending Orders Dashboard</h2>
                    <p id="dashboard-date" class="text-sm text-gray-500"></p>
                </div>
                <div class="flex gap-2 flex-wrap items-center">
                    <!-- BT Button Added -->
                    <button id="pickup-connect-printer-btn" onclick="openPrinterManagerPopup()" class="bg-white border-2 border-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-100 font-bold shadow-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        <span id="pickup-printer-status-text">Connect Printer</span>
                    </button>
                    <!-- ### UPDATED ### -->
                    <button id="customer-promo-btn" onclick="openCustomerPromoManager()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600 font-bold shadow-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0110 9c-1.55 0-2.958.5-4.07 1.33A6.97 6.97 0 004 16c0 .34.024.673.07 1h8.86zM8 20H3a1 1 0 01-1-1v-2.259a9 9 0 011.603-5.02 5.002 5.002 0 013.14-2.58A5 5 0 0110 5a5 5 0 014.257 2.141A5.002 5.002 0 0117.4 9.12a9 9 0 011.6 5.02V19a1 1 0 01-1 1h-5a1 1 0 110-2h2.03a7 7 0 00-1.28-3.43 3 3 0 00-2.52-1.34 3 3 0 00-2.52 1.34A7 7 0 006.97 18H9a1 1 0 110 2z" />
                        </svg>
                        Customer Promos
                    </button>
                    <button onclick="openMachineStatusManager()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 font-bold shadow-sm">
                        Manage Active Machines
                    </button>
                    <button onclick="generateEndOfDayReport()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-bold shadow-sm">
                        Generate End of Day Report
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div class="bg-green-100 p-4 rounded-lg border border-green-200 text-center">
                    <p class="text-sm font-medium text-green-800">Today's Collected Revenue</p>
                    <p id="pickup-dashboard-sales" class="text-2xl font-bold text-green-900 mt-1">₱0.00</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg border border-yellow-200 text-center">
                    <p class="text-sm font-medium text-yellow-800">For Collection</p> <!-- Changed from "For Collection (Count)" -->
                    <p id="pickup-dashboard-for-collection" class="text-2xl font-bold text-yellow-900 mt-1">0</p> <!-- Changed ID -->
                </div>
                <div class="bg-red-100 p-4 rounded-lg border border-red-200 text-center">
                    <p class="text-sm font-medium text-red-800">Total Sales (Today)</p>
                    <p id="pickup-dashboard-pending-value" class="text-2xl font-bold text-red-900 mt-1">₱0.00</p>
                </div>
            </div>
        </div>

        <!-- PENDING ORDERS CONTENT -->
        <div id="pending-orders-content" class="space-y-4">
            <!-- ### NEW FEATURE: LIVE FILTER FOR PENDING ORDERS ### -->
            <div class="relative">
                <input type="text" id="pickupSearchInput" placeholder="Filter pending orders by OR#, Name, or Phone..." class="border p-3 w-full rounded-md shadow-sm pl-10">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            <div id="pending-list-container" class="space-y-3"></div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-lg z-50 p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Owner Settings</h2><button onclick="closeSettingsPanel()" class="text-gray-500 hover:text-red-500 text-3xl leading-none">&times;</button></div>
        <div class="border-b border-gray-200 mb-4">
            <nav class="-mb-px flex space-x-4 text-sm font-medium text-center overflow-x-auto" aria-label="Tabs">
                <button id="tab-button-reports" onclick="showSettingsTab('reports')" class="settings-tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium">Advanced Reports</button>
                <button id="tab-button-machines" onclick="showSettingsTab('machines')" class="settings-tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium">Machines</button>
                <button id="tab-button-config" onclick="showSettingsTab('config')" class="settings-tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium">Shop Config</button>
                <button id="tab-button-data" onclick="showSettingsTab('data')" class="settings-tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium">Data & Security</button>
            </nav>
        </div>
        <div id="settings-tab-content-container" class="space-y-6">
            <div id="tab-content-reports" class="settings-tab-content"><div class="p-4 border rounded border-purple-300 bg-purple-50"><h3 class="text-lg font-semibold mb-3 text-purple-800">Advanced Reports</h3>
                <p class="text-sm text-gray-600 mb-4">Use these tools for monthly analysis or to review sales from a specific past date. The main "End of Day Report" is on the Pickup Dashboard.</p>
                <div class="space-y-6">
                    <div class="border-t border-purple-200 pt-4">
                        <h5 class="font-semibold mb-2">Review Specific Day</h5>
                        <input type="date" id="reviewDate" class="border p-2 w-full mb-2" /><button onclick="toggleDailyReport()" id="daily-report-btn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 w-full">View Daily Details</button><div id="salesList" class="mt-2" style="display:none;"></div>
                    </div>
                    <!-- UPDATED: Excel Export moved here with custom date range -->
                    <div class="border-t border-purple-200 pt-4">
                        <h5 class="font-semibold mb-2">Generate Detailed Excel Report</h5>
                        <div class="flex flex-col md:flex-row gap-2 mb-2">
                            <input type="date" id="reportStartDate" class="border p-2 w-full">
                            <input type="date" id="reportEndDate" class="border p-2 w-full">
                        </div>
                        <button onclick="generateExcelReport()" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 w-full">Export Detailed Report (Excel)</button>
                    </div>
                    <!-- ### NEW PROFESSIONAL MONTHLY REPORT SECTION ### -->
                    <div class="border-t border-purple-200 pt-4">
                        <h5 class="font-semibold mb-2">Professional Monthly Report</h5>
                        <div class="flex gap-2 mb-2">
                            <input type="month" id="reportMonth" class="border p-2 w-full">
                            <button onclick="generateNewMonthlyReport()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 whitespace-nowrap">Generate Report</button>
                        </div>
                        <div id="monthly-report-output" class="mt-4 space-y-6 hidden">
                            <!-- Report Title -->
                            <h4 id="monthly-report-title" class="text-xl font-bold text-purple-900 text-center"></h4>

                            <!-- KPIs -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                                <div class="bg-green-100 p-3 rounded-lg border border-green-200"><p class="text-xs font-medium text-green-800">Total Collected Revenue</p><p id="monthlyTotalCollected" class="text-2xl font-bold text-green-900"></p></div>
                                <div class="bg-blue-100 p-3 rounded-lg border border-blue-200"><p class="text-xs font-medium text-blue-800">Total Sales Value</p><p id="monthlyTotalSales" class="text-2xl font-bold text-blue-900"></p></div>
                                <div class="bg-yellow-100 p-3 rounded-lg border border-yellow-200"><p class="text-xs font-medium text-yellow-800">Net (Collected vs Sales)</p><p id="monthlyNet" class="text-2xl font-bold text-yellow-900"></p></div>
                                <div class="bg-indigo-100 p-3 rounded-lg border border-indigo-200"><p class="text-xs font-medium text-indigo-800">Total Orders</p><p id="monthlyTotalOrders" class="text-2xl font-bold text-indigo-900"></p></div>
                                <div class="bg-gray-100 p-3 rounded-lg border border-gray-200 col-span-2 md:col-span-1"><p class="text-xs font-medium text-gray-800">Average Sale Value</p><p id="monthlyAvgSale" class="text-2xl font-bold text-gray-900"></p></div>
                            </div>

                            <!-- Analysis and Insights -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-4 rounded-lg border">
                                    <h5 class="font-bold text-purple-800 mb-2">Performance vs.</h5>
                                    <div class="space-y-3">
                                        <div><p class="text-xs text-gray-500">Previous Month (Sales)</p><p id="vsPrevMonth" class="font-semibold"></p></div>
                                        <div><p class="text-xs text-gray-500">Same Month Last Year (Sales)</p><p id="vsPrevYear" class="font-semibold"></p></div>
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border">
                                    <h5 class="font-bold text-purple-800 mb-2">Weekly Performance</h5>
                                    <div class="space-y-3">
                                        <div><p class="text-xs text-gray-500">Busiest Day of the Week</p><p id="busiestDay" class="font-semibold text-green-700"></p></div>
                                        <div><p class="text-xs text-gray-500">Quietest Day of the Week</p><p id="quietestDay" class="font-semibold text-red-700"></p></div>
                                    </div>
                                </div>
                            </div>

                            <div><h5 class="font-bold text-purple-800 mb-2">Daily Sales Chart</h5><canvas id="monthlySalesChart"></canvas></div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-4 rounded-lg border">
                                    <h5 class="font-bold text-purple-800 mb-2">Top Selling Services</h5>
                                    <div id="top-services-list" class="space-y-2"></div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border">
                                    <h5 class="font-bold text-purple-800 mb-2">Top Customers</h5>
                                    <div id="top-customers-list" class="space-y-2"></div>
                                </div>
                            </div>

                            <div>
                                <h5 class="font-bold text-purple-800 mb-2">Daily Performance Breakdown</h5>
                                <div id="daily-breakdown-table" class="max-h-64 overflow-y-auto border rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div></div>
            <div id="tab-content-machines" class="settings-tab-content hidden"><div class="p-4 border rounded border-green-300 bg-green-50"><h3 class="text-lg font-semibold mb-3 text-green-800">Machine Configuration</h3><div class="space-y-3"><div><label for="settingNumWashers" class="block font-medium">Number of Washers</label><input id="settingNumWashers" type="number" class="border p-2 w-full mt-1" placeholder="e.g., 2"></div><div><label for="settingNumDryers" class="block font-medium">Number of Dryers</label><input id="settingNumDryers" type="number" class="border p-2 w-full mt-1" placeholder="e.g., 2"></div></div><button onclick="saveMachineSettings()" class="bg-green-600 text-white px-4 py-2 rounded mt-4 w-full hover:bg-green-700">Save Machine Config</button><hr class="my-6 border-green-200"><div id="machine-cycle-display"><h4 class="text-md font-bold mb-2 text-green-700">Live Cycle Counts & Status</h4><div id="owner-machine-status-container"></div></div><hr class="my-6 border-green-200"><div id="machine-usage-report"><h4 class="text-md font-bold mb-2 text-green-700">Machine Usage Report</h4><button onclick="toggleMachineReport()" id="machine-report-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">Show Report</button><div id="machine-usage-report-container" class="mt-4 space-y-3 hidden"><div id="machine-usage-list" class="space-y-2"></div><div class="pt-4 border-t border-green-200"><button onclick="confirmResetAllCycleCounts()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 w-full">Reset All Cycle Counts</button><p class="text-xs text-gray-600 mt-1">Warning: This is permanent. Use this to start a new tracking period.</p></div></div></div></div></div>
            <div id="tab-content-config" class="settings-tab-content hidden space-y-6">
                <div class="p-4 border rounded">
                    <h3 class="text-lg font-semibold mb-3">Shop Information</h3>
                    <div class="space-y-3">
                        <div><label for="settingShopName" class="block font-medium">Shop Name</label><input id="settingShopName" type="text" class="border p-2 w-full mt-1"></div>
                        <div><label for="settingShopAddress" class="block font-medium">Address</label><input id="settingShopAddress" type="text" class="border p-2 w-full mt-1"></div>
                        <div><label for="settingShopPhone" class="block font-medium">Phone Number</label><input id="settingShopPhone" type="text" class="border p-2 w-full mt-1"></div>
                        <div><label for="settingQrUrl" class="block font-medium">QR Code URL (Optional)</label><input id="settingQrUrl" type="text" placeholder="e.g., https://facebook.com/yourshop" class="border p-2 w-full mt-1"></div>
                    </div>
                    <button onclick="saveShopInfo()" class="bg-blue-500 text-white px-4 py-2 rounded mt-4 w-full">Save Shop Info</button>
                </div>
                <!-- ### UPDATED ### SMS Settings Section -->
                <div class="p-4 border rounded border-purple-300 bg-purple-50">
                    <h3 class="text-lg font-semibold mb-3 text-purple-800">SMS Notification Settings</h3>

                    <div class="flex items-center justify-between mb-4">
                        <label for="settingSmsEnabled" class="font-medium">Enable SMS Features</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="settingSmsEnabled" onchange="toggleSmsSettings()" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>

                    <div id="sms-config-details" class="space-y-3">
                        <p class="text-sm text-gray-600 mb-3">Configure your SMS API endpoint and custom message for pickup notifications. Use <code>[Customer Name]</code>, <code>[OR Number]</code>, and <code>[Shop Name]</code> as placeholders.</p>
                        <div>
                            <label for="settingSmsApiUrl" class="block font-medium">SMS API URL (e.g., https://your-api.com/textsms?)</label>
                            <input id="settingSmsApiUrl" type="url" placeholder="https://final-k541.onrender.com/textsms?" class="border p-2 w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">Ensure this API accepts 'n' for phone and 't' for text parameters.</p>
                        </div>
                        <div>
                            <label for="settingSmsPickupMessageTemplate" class="block font-medium">Pickup Ready Message Template</label>
                            <textarea id="settingSmsPickupMessageTemplate" rows="3" class="border p-2 w-full mt-1" placeholder="Hi [Customer Name], your Mama's Love Laundry order #[OR Number] is now ready for pickup! Thank you from [Shop Name]."></textarea>
                        </div>
                        <button onclick="saveSmsSettings()" class="bg-purple-600 text-white px-4 py-2 rounded mt-4 w-full hover:bg-purple-700">Save SMS Config</button>
                    </div>
                </div>
                <div class="p-4 border rounded"><h3 class="text-lg font-semibold mb-3">Service Management</h3><div id="service-list-container" class="space-y-2 mb-4"></div><div class="p-3 bg-gray-50 rounded border"><h4 id="service-form-title" class="font-semibold mb-2">Add New Service</h4><input type="hidden" id="service-id"><div class="space-y-3"><div><label for="service-label" class="block font-medium">Service Name / Label</label><input id="service-label" type="text" placeholder="e.g., 8kg Mix, Bedsheet" class="border p-2 w-full mt-1"></div><div><label for="service-price" class="block font-medium">Price (₱)</label><input id="service-price" type="number" placeholder="e.g., 160 or 70" class="border p-2 w-full mt-1"></div><div><label for="service-type" class="block font-medium">Pricing Type</label><select id="service-type" class="border p-2 w-full mt-1"><option value="fixed">Fixed Price</option><option value="per_kg">Price per kg</option></select></div><div class="flex gap-2"><button onclick="saveService()" class="bg-green-500 text-white px-4 py-2 rounded w-full">Save Service</button><button onclick="clearServiceForm()" class="bg-gray-300 px-4 py-2 rounded w-full">Cancel</button></div></div></div></div></div>
            <div id="tab-content-data" class="settings-tab-content hidden space-y-6">
                <!-- ### NEW ### Staff Security Section -->
                <div class="p-4 border rounded border-green-300 bg-green-50">
                    <h3 class="text-lg font-semibold mb-3 text-green-800">Staff Security</h3>
                    <p class="text-sm text-gray-600 mb-3">Set the password staff will use to access the POS system upon opening the site.</p>
                    <div class="space-y-3">
                        <div><label for="newStaffPassword" class="block font-medium">New Staff Password</label><input id="newStaffPassword" type="password" class="border p-2 w-full mt-1"></div>
                        <div><label for="confirmStaffPassword" class="block font-medium">Confirm New Staff Password</label><input id="confirmStaffPassword" type="password" class="border p-2 w-full mt-1"></div>
                    </div>
                    <button onclick="saveStaffPassword()" class="bg-green-600 text-white px-4 py-2 rounded mt-4 w-full hover:bg-green-700">Change Staff Password</button>
                </div>
                <!-- Owner Security Section -->
                <div class="p-4 border rounded border-blue-300 bg-blue-50">
                    <h3 class="text-lg font-semibold mb-3 text-blue-800">Owner Security</h3>
                    <div class="space-y-3"><div><label for="currentPassword" class="block font-medium">Current Owner Password</label><input id="currentPassword" type="password" class="border p-2 w-full mt-1"></div><div><label for="newPassword" class="block font-medium">New Owner Password</label><input id="newPassword" type="password" oninput="updatePasswordStrength()" class="border p-2 w-full mt-1"></div><!-- NEW: Password Strength Indicator --><div><div id="password-strength-indicator"></div></div><div><label for="confirmPassword" class="block font-medium">Confirm New Owner Password</label><input id="confirmPassword" type="password" class="border p-2 w-full mt-1"></div></div>
                    <button onclick="savePassword()" class="bg-blue-600 text-white px-4 py-2 rounded mt-4 w-full hover:bg-blue-700">Change Owner Password</button>
                </div>
                <div class="p-4 border border-red-300 bg-red-50 rounded"><h3 class="text-lg font-semibold mb-3 text-red-800">Data Management</h3><div class="space-y-4">
                    <div><button onclick="backupData()" class="bg-green-600 text-white px-4 py-2 rounded w-full hover:bg-green-700">Backup All Data to File</button><p class="text-xs text-gray-600 mt-1">Saves a local copy of all sales, services, and settings to a JSON file.</p></div>
                    <!-- ### NEW UPDATE BUTTON ### -->
                    <div>
                        <button onclick="checkForUpdates()" class="bg-cyan-600 text-white px-4 py-2 rounded w-full hover:bg-cyan-700">Check for Site Updates</button>
                        <p class="text-xs text-gray-600 mt-1">Pulls the latest version of the POS from GitHub and reloads the page.</p>
                    </div>
                    <!-- ######################## -->
                    <div><button onclick="triggerRestore()" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700">Restore Data from File</button><p class="text-xs text-gray-600 mt-1">WARNING: This will overwrite all current data in Firestore.</p></div><hr>
                    <div><button onclick="confirmTransactionalReset()" class="bg-yellow-500 text-white px-4 py-2 rounded w-full hover:bg-yellow-600">Reset Sales Data</button><p class="text-xs text-gray-600 mt-1">Deletes all sales records and resets the OR number. Services and Settings are NOT affected.</p></div>
                    <div><button onclick="confirmMasterReset()" class="bg-red-600 text-white px-4 py-2 rounded w-full hover:bg-red-700">Factory Reset</button><p class="text-xs text-gray-600 mt-1">Deletes EVERYTHING from Firestore. The app will return to its default state.</p></div>
                </div></div>
            </div>
        </div>
    </div>
  </div>

  <div id="receiptSection" class="bg-white p-1 hidden print:block">
      <div class="receipt-content text-xs font-mono mx-auto" style="width: 57mm;">
          <div id="receipt-header" class="text-center space-y-0"> <!-- Reduced spacing -->
              <h2 id="receiptShopName" class="font-bold"></h2>
              <p id="receiptShopAddress"></p>
              <p id="receiptShopPhone"></p>
          </div>
          <p class="text-center font-mono">------------------------------</p>
          <div class="text-center font-bold">
              <p>OFFICIAL RECEIPT</p>
          </div>
          <p class="text-center font-mono">------------------------------</p>
          <div id="receipt-details-compact" class="space-y-0"></div> <!-- Reduced spacing -->
          <p class="text-center font-mono">------------------------------</p>
          <div id="receipt-items-compact"></div>
          <p class="text-center font-mono">------------------------------</p>
          <div id="receipt-summary-compact" class="space-y-0"></div> <!-- Reduced spacing -->
          <p class="text-center font-mono">------------------------------</p>
          <!-- NEW: QR Code will be rendered here -->
          <div id="receipt-qrcode" class="flex justify-center my-2"></div>
          <div class="text-center">
              <p>Thank you!</p>
          </div>
      </div>
      <div class="flex justify-center gap-2 mt-4 print:hidden">
          <button id="bt-print-receipt-btn" class="bg-cyan-500 text-white px-4 py-2 rounded hidden">Print via Bluetooth</button>
          <button onclick="window.print()" class="bg-indigo-500 text-white px-4 py-2 rounded">Print (Paper)</button>
          <button onclick="closeReceipt()" class="bg-gray-500 text-white px-4 py-2 rounded">Close</button>
      </div>
  </div>

  <script>
    // ### YOUR FIREBASE CONFIG OBJECT IS PASTED HERE ###
    const firebaseConfig = {
      apiKey: "AIzaSyAroc-0TvFXDvsVcvQ_ghlhyMQarVwVlB8",
      authDomain: "my-pos-laundry.firebaseapp.com",
      projectId: "my-pos-laundry",
      storageBucket: "my-pos-laundry.appspot.com",
      messagingSenderId: "40820558255",
      appId: "1:40820558255:web:e856b842bea93ef528475a",
      measurementId: "G-MQ4T2ZC4W4"
    };

    // ### NEW ### Initialize Firebase and Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // ### NEW ### Enable Firestore offline persistence
    db.enablePersistence().catch(err => {
        if (err.code == 'failed-precondition') {
            console.warn("Firestore persistence could not be enabled. This happens if multiple tabs are open.");
        } else if (err.code == 'unimplemented') {
            console.warn("The current browser does not support all of the features required to enable persistence.");
        }
    });

    // ### OPTIMIZATION ### Constants for collection names
    const COLLECTIONS = {
        TRANSACTIONS: 'transactions',
        SERVICES: 'services',
        CUSTOMERS: 'customers',
        CONFIG: 'config',
        MACHINE_STATUS: 'machineStatus'
    };


    // --- Global State ---
    let cart = [], shopSettings = {}, shopServices = [], shopCustomers = [];
    let machineConfig = { numWashers: 2, numDryers: 2 };
    let machineStatus = [];
    let monthlyChartInstance = null;
    let customerSearchTimeout; // For debouncing
    let idleTimer; // For auto-lock
    const TIMEZONE = "Asia/Manila";

    // --- BT --- Bluetooth Global State ---
    let bluetoothDevice = null;
    let bluetoothWriteCharacteristic = null;
    let bluetoothSettings = { autoPrint: false };

    // --- Element Cache ---
    const allElements = {
        mainAppContainer: document.getElementById('main-app-container'),
        searchInputEl: document.getElementById('searchInput'), searchResultsEl: document.getElementById('searchResults'), nameEl: document.getElementById('name'), phoneEl: document.getElementById('phone'), paymentTypeEl: document.getElementById('paymentType'), totalEl: document.getElementById('total'), receiptSection: document.getElementById('receiptSection'), reviewDateEl: document.getElementById('reviewDate'), salesListEl: document.getElementById('salesList'), loadingIndicator: document.getElementById('loadingIndicator'),
        settingsPanel: document.getElementById('settings-panel'), settingShopName: document.getElementById('settingShopName'), settingShopAddress: document.getElementById('settingShopAddress'), settingShopPhone: document.getElementById('settingShopPhone'), settingQrUrl: document.getElementById('settingQrUrl'), serviceButtonsContainer: document.getElementById('service-buttons-container'), serviceLoader: document.getElementById('service-loader'), serviceListContainer: document.getElementById('service-list-container'), serviceFormTitle: document.getElementById('service-form-title'), serviceId: document.getElementById('service-id'), serviceLabel: document.getElementById('service-label'), servicePrice: document.getElementById('service-price'), serviceType: document.getElementById('service-type'),
        receiptShopName: document.getElementById('receiptShopName'), receiptShopAddress: document.getElementById('receiptShopAddress'), receiptShopPhone: document.getElementById('receiptShopPhone'), receiptQrCode: document.getElementById('receipt-qrcode'),
        currentPasswordEl: document.getElementById('currentPassword'), newPasswordEl: document.getElementById('newPassword'), confirmPasswordEl: document.getElementById('confirmPassword'),
        posView: document.getElementById('pos-view'), toPosBtn: document.getElementById('to-pos-btn'), findOrderSection: document.getElementById('find-order-section'),
        pickupView: document.getElementById('pickup-view'), toPickupBtn: document.getElementById('to-pickup-btn'),
        customerSearchResults: document.getElementById('customer-search-results'),
        headerTitle: document.getElementById('header-title'),
        pendingListContainer: document.getElementById('pending-list-container'),
        pickupSearchInput: document.getElementById('pickupSearchInput'),
        // BT Elements
        pickupConnectPrinterBtn: document.getElementById('pickup-connect-printer-btn'),
        pickupPrinterStatusText: document.getElementById('pickup-printer-status-text'),
        btPrintReceiptBtn: document.getElementById('bt-print-receipt-btn'),
        // Dashboard elements
        pickupDashboardSales: document.getElementById('pickup-dashboard-sales'),
        pickupDashboardForCollection: document.getElementById('pickup-dashboard-for-collection'),
        pickupDashboardTotalSales: document.getElementById('pickup-dashboard-pending-value'),
        loadingIndicatorText: document.getElementById('loadingIndicatorText'),
        // SMS elements
        settingSmsEnabled: document.getElementById('settingSmsEnabled'),
        smsConfigDetails: document.getElementById('sms-config-details'),
        settingSmsApiUrl: document.getElementById('settingSmsApiUrl'),
        settingSmsPickupMessageTemplate: document.getElementById('settingSmsPickupMessageTemplate'),
        customerPromoBtn: document.getElementById('customer-promo-btn'),
    };

    // --- Core App & UI Functions ---
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });

    function showLoading(show, text = 'Processing...') {
        allElements.loadingIndicatorText.textContent = text;
        allElements.loadingIndicator.style.display = show ? 'flex' : 'none';
    }

    function closeReceipt() { allElements.receiptSection.classList.add('hidden'); allElements.findOrderSection.classList.remove('hidden'); }

    function showView(viewId) {
        document.querySelectorAll('.main-view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');

        if (viewId === 'pos-view') {
            allElements.toPosBtn.classList.add('hidden');
            allElements.toPickupBtn.classList.remove('hidden');
        } else if (viewId === 'pickup-view') {
            allElements.toPosBtn.classList.remove('hidden');
            allElements.toPickupBtn.classList.add('hidden');
            // Data for this view is now loaded via real-time listeners, no need to call render functions here
        }
    }

    // ### NEW ### Staff Login Logic
    async function promptStaffLogin() {
        const passwordDoc = await db.collection(COLLECTIONS.CONFIG).doc('staffPassword').get();
        const correctPassword = passwordDoc.exists ? passwordDoc.data().value : 'admin';

        const { value: passwordGuess } = await Swal.fire({
            title: 'Staff Login',
            text: 'Please enter the staff password to continue.',
            input: 'password',
            inputPlaceholder: 'Enter your password',
            confirmButtonText: 'Login',
            allowOutsideClick: false,
            allowEscapeKey: false,
            inputValidator: (value) => {
                if (!value) {
                    return 'Password is required!'
                }
            }
        });

        if (passwordGuess === correctPassword) {
            allElements.mainAppContainer.classList.remove('hidden');
            initializeApp();
        } else {
            await Swal.fire({
                icon: 'error',
                title: 'Access Denied',
                text: 'Incorrect password. Please try again.',
                allowOutsideClick: false,
                allowEscapeKey: false,
            });
            promptStaffLogin(); // Prompt again if wrong
        }
    }

    async function initializeApp() {
        showLoading(true, 'Initializing app...');

        // Event Listeners
        allElements.nameEl.addEventListener('input', debouncedSearchCustomers);
        allElements.phoneEl.addEventListener('input', debouncedSearchCustomers);
        allElements.pickupSearchInput.addEventListener('input', () => renderPickupView());

        // Setup default report dates
        allElements.reviewDateEl.value = dayjs().tz(TIMEZONE).format("YYYY-MM-DD");
        document.getElementById('reportStartDate').value = dayjs().tz(TIMEZONE).startOf('month').format('YYYY-MM-DD');
        document.getElementById('reportEndDate').value = dayjs().tz(TIMEZONE).endOf('month').format('YYYY-MM-DD');
        document.getElementById('reportMonth').value = dayjs().tz(TIMEZONE).format('YYYY-MM'); // Sets default month for new report

        showView('pos-view');

        // ### NEW ### One-time migration from localforage to Firestore
        await migrateDataToFirestore();

        // ### NEW ### Set up real-time listeners for all synchronized data
        setupRealtimeListeners();

        // Load non-synced, device-specific data from localforage
        bluetoothSettings = await localforage.getItem('bluetooth_settings') || { autoPrint: false };
        updateBluetoothUI();

        showLoading(false);
        startIdleTimer();
    }

    function setupRealtimeListeners() {
        // Listener for Shop Settings
        db.collection(COLLECTIONS.CONFIG).doc('shopSettings').onSnapshot(doc => {
            const defaultSettings = {
                name: "MAMA'S LOVE LAUNDRY", address: "123 Laundry St, Manila", phone: "0912-345-6789", qrUrl: "",
                smsEnabled: true, smsApiUrl: "https://final-k541.onrender.com/textsms?",
                smsPickupMessageTemplate: "Hi [Customer Name], your Mama's Love Laundry order #[OR Number] is now ready for pickup! Thank you from [Shop Name]."
            };
            if (doc.exists) {
                shopSettings = { ...defaultSettings, ...doc.data() };
            } else {
                shopSettings = defaultSettings;
                db.collection(COLLECTIONS.CONFIG).doc('shopSettings').set(shopSettings);
            }
            renderShopInfo();
            renderSmsSettings();
            renderPickupDashboard();
        });

        // Listener for Services
        allElements.serviceLoader.style.display = 'block';
        db.collection(COLLECTIONS.SERVICES).orderBy('label').onSnapshot(snapshot => {
            shopServices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (shopServices.length === 0) {
                const defaultServices = [
                    { label: "Regular 8kg", price: 160, type: "fixed" },
                    { label: "Comforter", price: 70, type: "per_kg" },
                    { label: "Bedsheet", price: 70, type: "per_kg" }
                ];
                const batch = db.batch();
                defaultServices.forEach(service => {
                    const docRef = db.collection(COLLECTIONS.SERVICES).doc();
                    batch.set(docRef, service);
                });
                batch.commit();
            }
            renderServiceButtons();
            renderServiceList();
        });

        // Listener for Customers
        db.collection(COLLECTIONS.CUSTOMERS).onSnapshot(snapshot => {
            shopCustomers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        });

        // Listener for Machine Config
        db.collection(COLLECTIONS.CONFIG).doc('machineConfig').onSnapshot(doc => {
            if (doc.exists) {
                machineConfig = doc.data();
            } else {
                machineConfig = { numWashers: 2, numDryers: 2 };
                db.collection(COLLECTIONS.CONFIG).doc('machineConfig').set(machineConfig);
            }
            renderMachineSettings();
        });

        // Listener for Machine Status
        db.collection(COLLECTIONS.MACHINE_STATUS).orderBy('set').onSnapshot(snapshot => {
            machineStatus = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
             if (machineStatus.length !== (machineConfig.numWashers + machineConfig.numDryers)) {
                initializeMachineStatus(); // If count mismatch, re-initialize
            }
            renderOwnerMachineStatus();
        });

        // Listener for Pending Pickups (which are just transactions with balanceDue > 0)
        db.collection(COLLECTIONS.TRANSACTIONS).where('balanceDue', '>', 0).onSnapshot(snapshot => {
            renderPickupView();
            renderPickupDashboard();
        });

        // Listener for today's transactions to update dashboard
        const todayStart = dayjs().tz(TIMEZONE).startOf('day').toISOString();
        const todayEnd = dayjs().tz(TIMEZONE).endOf('day').toISOString();
        db.collection(COLLECTIONS.TRANSACTIONS).where('time', '>=', todayStart).where('time', '<=', todayEnd)
          .onSnapshot(snapshot => {
             renderPickupDashboard();
          });
    }


    function runInBackground(task) {
        if (typeof requestIdleCallback === 'function') {
            requestIdleCallback(task);
        } else {
            setTimeout(task, 1);
        }
    }

    // ### NEW ### MIGRATION LOGIC
    async function migrateDataToFirestore() {
        const migrationDone = await localforage.getItem('firestore_migration_v1_done');
        if (migrationDone) {
            console.log("Firestore migration already completed. Skipping.");
            return;
        }

        showLoading(true, "Migrating local data to cloud...");
        Toast.fire({icon: 'info', title: 'First-time setup: Syncing your data to the cloud...'});

        try {
            const batch = db.batch();

            // Migrate Customers
            const localCustomers = await localforage.getItem('shop_customers') || [];
            if (localCustomers.length > 0) {
                localCustomers.forEach(customer => {
                    const docRef = db.collection(COLLECTIONS.CUSTOMERS).doc(String(customer.phone || customer.id)); // Use phone as ID for uniqueness
                    batch.set(docRef, customer);
                });
            }

            // Migrate Machine Config & Status
            const localMachineConfig = await localforage.getItem('machine_config');
            if(localMachineConfig) batch.set(db.collection(COLLECTIONS.CONFIG).doc('machineConfig'), localMachineConfig);

            const localMachineStatus = await localforage.getItem('machine_status');
            if(localMachineStatus) {
                localMachineStatus.forEach(m => batch.set(db.collection(COLLECTIONS.MACHINE_STATUS).doc(m.id), m));
            }

            // Migrate Transactions
            const keys = await localforage.keys();
            const dateKeys = keys.filter(k => /^\d{4}-\d{2}-\d{2}$/.test(k));
            for (const key of dateKeys) {
                const dailyData = await localforage.getItem(key) || [];
                dailyData.forEach(tx => {
                    const docRef = db.collection(COLLECTIONS.TRANSACTIONS).doc(tx.orNumber);
                    batch.set(docRef, tx);
                });
            }

            // Migrate OR Counter
            const localOrCounter = await localforage.getItem('global_or_counter');
            if(localOrCounter) batch.set(db.collection(COLLECTIONS.CONFIG).doc('orCounter'), { value: localOrCounter });

            // Migrate Password
            const localPassword = await localforage.getItem('app_password');
            if(localPassword) batch.set(db.collection(COLLECTIONS.CONFIG).doc('appPassword'), { value: localPassword });

            await batch.commit();
            await localforage.setItem('firestore_migration_v1_done', true);
            showLoading(false);
            Swal.fire('Migration Complete!', 'Your data has been successfully synced to the cloud. All your devices are now connected.', 'success');
        } catch (error) {
            showLoading(false);
            console.error("Firestore migration failed:", error);
            Swal.fire('Migration Failed', `Could not sync data to the cloud. Please check your internet connection and Firebase setup. Error: ${error.message}`, 'error');
        }
    }

    function processBatches(array, processItem, onComplete) {
        let index = 0;
        async function doStep() {
            if (index >= array.length) {
                if (onComplete) onComplete();
                return;
            }
            await processItem(array[index]);
            index++;
            setTimeout(doStep, 0);
        }
        doStep();
    }

    // --- Dashboard & Settings ---
    async function renderPickupDashboard() {
        document.getElementById('dashboard-date').textContent = dayjs().tz(TIMEZONE).format('dddd, MMMM D, YYYY');

        // Calculate Total Collected Today
        const totalCollectedToday = await getTotalCollectedToday();
        allElements.pickupDashboardSales.textContent = `₱${totalCollectedToday.toFixed(2)}`;

        // Calculate Total Sales Today
        const todayStart = dayjs().tz(TIMEZONE).startOf('day').toDate();
        const todayEnd = dayjs().tz(TIMEZONE).endOf('day').toDate();
        const todaySnapshot = await db.collection(COLLECTIONS.TRANSACTIONS)
                                    .where('time', '>=', todayStart.toISOString())
                                    .where('time', '<=', todayEnd.toISOString())
                                    .get();
        const totalSalesToday = todaySnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);
        allElements.pickupDashboardTotalSales.textContent = `₱${totalSalesToday.toFixed(2)}`;


        // Calculate "For Collection" stats
        const pendingSnapshot = await db.collection(COLLECTIONS.TRANSACTIONS).where('balanceDue', '>', 0).get();
        const forCollectionCount = pendingSnapshot.size;
        const totalValueForCollection = pendingSnapshot.docs.reduce((sum, doc) => sum + doc.data().balanceDue, 0);
        allElements.pickupDashboardForCollection.textContent = `₱${totalValueForCollection.toFixed(2)} (${forCollectionCount} orders)`;

        allElements.customerPromoBtn.style.display = shopSettings.smsEnabled ? 'flex' : 'none';
    }

    async function getTotalCollectedToday() {
        let collectedSum = 0;
        const todayStart = dayjs().tz(TIMEZONE).startOf('day').toDate();
        const todayEnd = dayjs().tz(TIMEZONE).endOf('day').toDate();

        // Query for transactions where a payment was made today
        const snapshot = await db.collection(COLLECTIONS.TRANSACTIONS)
                               .where('paymentTimestamp', '>=', todayStart.toISOString())
                               .where('paymentTimestamp', '<=', todayEnd.toISOString())
                               .get();

        snapshot.docs.forEach(doc => {
            const tx = doc.data();
            // This logic is simplified because paymentTimestamp is updated for BOTH initial and balance payments.
            // We just need to check which kind of payment it was.
            if (tx.balancePaidAmount) { // It was a balance payment
                 collectedSum += tx.balancePaidAmount;
            } else if (tx.paymentType === 'down_payment') { // It was an initial down payment
                 collectedSum += tx.amountPaid;
            } else if (tx.paymentType === 'paid') { // It was a full payment from the start
                 collectedSum += tx.total; // The actual revenue is the total, not amountPaid (which includes change)
            }
        });

        return collectedSum;
    }


    function closeSettingsPanel() { allElements.settingsPanel.classList.remove('open'); }

    function showSettingsTab(tabName) {
        document.querySelectorAll('.settings-tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.settings-tab-button').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
        document.getElementById(`tab-button-${tabName}`).classList.add('active');
        if (tabName === 'reports') {
        } else if (tabName === 'machines') {
            renderOwnerMachineStatus();
        } else if (tabName === 'config') {
            renderSmsSettings();
        }
    }

    async function openSettingsWithPassword() {
        const { value: passwordGuess } = await Swal.fire({
            title: 'Enter Owner Password',
            input: 'password',
            inputPlaceholder: 'Enter your password',
            inputAttributes: { autocapitalize: 'off', autocorrect: 'off' },
            showCancelButton: true,
            confirmButtonText: 'Unlock',
            confirmButtonColor: '#3b82f6'
        });
        if (passwordGuess) {
            const passwordDoc = await db.collection(COLLECTIONS.CONFIG).doc('appPassword').get();
            const correctPassword = passwordDoc.exists ? passwordDoc.data().value : 'root';
            if (passwordGuess === correctPassword) {
                allElements.settingsPanel.classList.add('open');
                allElements.currentPasswordEl.value = '';
                allElements.newPasswordEl.value = '';
                allElements.confirmPasswordEl.value = '';
                document.getElementById('newStaffPassword').value = '';
                document.getElementById('confirmStaffPassword').value = '';
                updatePasswordStrength();
                showSettingsTab('reports');
            } else {
                Swal.fire({ icon: 'error', title: 'Access Denied', text: 'Incorrect password.' });
            }
        }
    }

    function updatePasswordStrength() {
        const password = allElements.newPasswordEl.value;
        const indicator = document.getElementById('password-strength-indicator');
        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^a-zA-Z0-9]/)) strength++;

        indicator.className = '';
        if (password.length > 0) {
            if (strength <= 2) indicator.classList.add('strength-weak');
            else if (strength === 3) indicator.classList.add('strength-medium');
            else indicator.classList.add('strength-strong');
        }
    }

    function startIdleTimer() {
        const idleTimeout = 15 * 60 * 1000; // 15 minutes
        const resetTimer = () => {
            clearTimeout(idleTimer);
            if (allElements.settingsPanel.classList.contains('open')) {
                idleTimer = setTimeout(() => {
                    closeSettingsPanel();
                    Swal.fire({
                        title: 'Session Locked',
                        text: 'You have been inactive. Please enter your password to continue.',
                        icon: 'warning',
                        allowOutsideClick: false,
                    });
                }, idleTimeout);
            }
        };
        window.addEventListener('mousemove', resetTimer, true);
        window.addEventListener('keypress', resetTimer, true);
        window.addEventListener('scroll', resetTimer, true);
        resetTimer();
    }


    async function savePassword() {
        const currentPassword = allElements.currentPasswordEl.value, newPassword = allElements.newPasswordEl.value, confirmPassword = allElements.confirmPasswordEl.value;
        if (!currentPassword || !newPassword || !confirmPassword) return Swal.fire('Error', 'Please fill all owner password fields.', 'error');

        const passwordDoc = await db.collection(COLLECTIONS.CONFIG).doc('appPassword').get();
        const correctPassword = passwordDoc.exists ? passwordDoc.data().value : 'root';

        if (currentPassword !== correctPassword) return Swal.fire('Error', 'Current owner password is not correct.', 'error');
        if (newPassword.length < 8) return Swal.fire('Error', 'New owner password must be at least 8 characters long.', 'error');
        if (newPassword !== confirmPassword) return Swal.fire('Error', 'New owner passwords do not match.', 'error');

        await db.collection(COLLECTIONS.CONFIG).doc('appPassword').set({ value: newPassword });
        Toast.fire({ icon: 'success', title: 'Owner password changed successfully!' });
    }

    // ### NEW ### Save Staff Password
    async function saveStaffPassword() {
        const newPassword = document.getElementById('newStaffPassword').value;
        const confirmPassword = document.getElementById('confirmStaffPassword').value;

        if (!newPassword || !confirmPassword) return Swal.fire('Error', 'Please fill all staff password fields.', 'error');
        if (newPassword.length < 4) return Swal.fire('Error', 'New staff password must be at least 4 characters long.', 'error');
        if (newPassword !== confirmPassword) return Swal.fire('Error', 'New staff passwords do not match.', 'error');

        await db.collection(COLLECTIONS.CONFIG).doc('staffPassword').set({ value: newPassword });
        Toast.fire({ icon: 'success', title: 'Staff password changed successfully!' });
        document.getElementById('newStaffPassword').value = '';
        document.getElementById('confirmStaffPassword').value = '';
    }

    function renderShopInfo() {
        allElements.headerTitle.textContent = shopSettings.name;
        allElements.receiptShopName.textContent = shopSettings.name;
        allElements.receiptShopAddress.textContent = shopSettings.address;
        allElements.receiptShopPhone.textContent = shopSettings.phone;
        allElements.settingShopName.value = shopSettings.name;
        allElements.settingShopAddress.value = shopSettings.address;
        allElements.settingShopPhone.value = shopSettings.phone;
        allElements.settingQrUrl.value = shopSettings.qrUrl || '';
        document.title = `${shopSettings.name} POS`;
    }

    async function saveShopInfo() {
        const newShopSettings = {
            name: allElements.settingShopName.value,
            address: allElements.settingShopAddress.value,
            phone: allElements.settingShopPhone.value,
            qrUrl: allElements.settingQrUrl.value
        };
        await db.collection(COLLECTIONS.CONFIG).doc('shopSettings').update(newShopSettings);
        Toast.fire({ icon: 'success', title: 'Shop info saved!' });
    }

    function renderSmsSettings() {
        allElements.settingSmsEnabled.checked = shopSettings.smsEnabled;
        allElements.settingSmsApiUrl.value = shopSettings.smsApiUrl || '';
        allElements.settingSmsPickupMessageTemplate.value = shopSettings.smsPickupMessageTemplate || '';
        toggleSmsSettings(false); // Update UI without saving
    }

    async function saveSmsSettings() {
        const newSmsSettings = {
            smsEnabled: allElements.settingSmsEnabled.checked,
            smsApiUrl: allElements.settingSmsApiUrl.value.trim(),
            smsPickupMessageTemplate: allElements.settingSmsPickupMessageTemplate.value.trim()
        };
        await db.collection(COLLECTIONS.CONFIG).doc('shopSettings').update(newSmsSettings);
        Toast.fire({ icon: 'success', title: 'SMS settings saved!' });
    }

    function toggleSmsSettings(save = true) {
        const isEnabled = allElements.settingSmsEnabled.checked;
        allElements.smsConfigDetails.style.display = isEnabled ? 'block' : 'none';
        if (save) {
            saveSmsSettings();
        }
    }

    // --- Service & Machine Management ---
    function renderServiceButtons() {
        const c = allElements.serviceButtonsContainer;
        c.innerHTML = '';
        allElements.serviceLoader.style.display = 'none';
        const fS = shopServices.filter(s => s.type === 'fixed'), pS = shopServices.filter(s => s.type === 'per_kg');

        if (fS.length > 0) {
            const fC = document.createElement('div');
            fC.className = 'grid grid-cols-2 gap-3 mb-2';
            fC.innerHTML = '<label class="block font-semibold col-span-2">Fixed Price Services:</label>';
            fS.forEach(s => {
                const b = document.createElement('button');
                b.className = 'bg-blue-500 text-white p-3 rounded hover:bg-blue-600 transition flex flex-col items-center justify-center';
                b.innerHTML = `<span class="font-semibold">${s.label}</span><span class="text-xs">₱${s.price}</span>`;
                b.onclick = function() { addToCart(s.label, s.price, this); };
                fC.appendChild(b);
            });
            c.appendChild(fC);
        }

        if (pS.length > 0) {
            const pC = document.createElement('div');
            pC.className = 'mt-4 pt-4 border-t space-y-3';
            pC.innerHTML = '<label class="block font-semibold">Per-KG Services:</label>';
            pS.forEach(s => {
                const d = document.createElement('div');
                d.innerHTML = `<label class="block font-medium">${s.label} (₱${s.price}/kg):</label><div class="flex items-center gap-2 mt-1"><input id="weight-input-${s.id}" type="number" step="0.1" placeholder="Enter weight in kg" class="border p-2 w-full" /><button onclick="addPerKgItemFromInput('${s.id}', '${s.label.replace(/'/g, "\\'")}', ${s.price}, this)" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition whitespace-nowrap">Add</button></div>`;
                pC.appendChild(d);
            });
            c.appendChild(pC);
        }
    }

    function renderServiceList() {
        allElements.serviceListContainer.innerHTML = '';
        shopServices.forEach(s => {
            const d = document.createElement('div');
            d.className = 'flex justify-between items-center p-2 border rounded';
            d.innerHTML = `<div><span class="font-semibold">${s.label}</span><span class="text-sm text-gray-600">- ₱${s.price} ${s.type === 'per_kg' ? '/kg' : ''}</span></div><div class="space-x-2"><button onclick="editService('${s.id}')" class="text-blue-500 hover:underline text-xs">Edit</button><button onclick="deleteService('${s.id}')" class="text-red-500 hover:underline text-xs">Delete</button></div>`;
            allElements.serviceListContainer.appendChild(d);
        });
    }

    function clearServiceForm() {
        allElements.serviceFormTitle.textContent = "Add New Service";
        Object.assign(allElements.serviceId, { value: '' });
        Object.assign(allElements.serviceLabel, { value: '', readOnly: false });
        Object.assign(allElements.servicePrice, { value: '', readOnly: false });
        Object.assign(allElements.serviceType, { value: 'fixed', readOnly: false });
    }

    async function saveService() {
        const id = allElements.serviceId.value;
        const label = allElements.serviceLabel.value;
        const price = parseFloat(allElements.servicePrice.value);
        const type = allElements.serviceType.value;
        if (!label || isNaN(price)) return Swal.fire('Invalid Input', 'Please enter a valid label and price.', 'error');

        const serviceData = { label, price, type };
        showLoading(true, 'Saving...');

        try {
            if (id) {
                await db.collection(COLLECTIONS.SERVICES).doc(id).update(serviceData);
            } else {
                await db.collection(COLLECTIONS.SERVICES).add(serviceData);
            }
            clearServiceForm();
            Toast.fire({ icon: 'success', title: 'Service saved!' });
        } catch (error) {
            console.error("Error saving service:", error);
            Swal.fire('Error', 'Could not save the service.', 'error');
        } finally {
            showLoading(false);
        }
    }

    function editService(id) {
        const s = shopServices.find(s => s.id == id);
        allElements.serviceFormTitle.textContent = "Edit Service";
        allElements.serviceId.value = s.id;
        allElements.serviceLabel.value = s.label;
        allElements.servicePrice.value = s.price;
        allElements.serviceType.value = s.type;
    }

    async function deleteService(id) {
        const r = await Swal.fire({ title: 'Are you sure?', text: "You won't be able to revert this!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, delete it!' });
        if (r.isConfirmed) {
            showLoading(true, 'Deleting...');
            try {
                await db.collection(COLLECTIONS.SERVICES).doc(id).delete();
                clearServiceForm();
                Swal.fire('Deleted!', 'The service has been deleted.', 'success');
            } catch (error) {
                console.error("Error deleting service:", error);
                Swal.fire('Error', 'Could not delete the service.', 'error');
            } finally {
                showLoading(false);
            }
        }
    }

    // --- UPGRADED Machine Set Management Functions ---
    function renderMachineSettings() { document.getElementById('settingNumWashers').value = machineConfig.numWashers; document.getElementById('settingNumDryers').value = machineConfig.numDryers; }

    async function initializeMachineStatus() {
        const batch = db.batch();
        const newStatus = [];
        for (let i = 1; i <= machineConfig.numWashers; i++) { newStatus.push({ id: `W${i}`, type: 'Washer', set: i, cycleCount: 0, isActive: true }); }
        for (let i = 1; i <= machineConfig.numDryers; i++) { newStatus.push({ id: `D${i}`, type: 'Dryer', set: i, cycleCount: 0, isActive: true }); }
        newStatus.forEach(m => {
            const docRef = db.collection(COLLECTIONS.MACHINE_STATUS).doc(m.id);
            batch.set(docRef, m);
        });
        await batch.commit();
    }

    async function toggleSetStatus(setId) {
        const washerRef = db.collection(COLLECTIONS.MACHINE_STATUS).doc(`W${setId}`);
        const dryerRef = db.collection(COLLECTIONS.MACHINE_STATUS).doc(`D${setId}`);
        const washer = machineStatus.find(m => m.id === `W${setId}`);

        if (washer) {
            const isCurrentlyActive = washer.isActive;
            const batch = db.batch();
            batch.update(washerRef, { isActive: !isCurrentlyActive });
            batch.update(dryerRef, { isActive: !isCurrentlyActive });
            await batch.commit();
        }
    }

    function getMachineManagerHTML(isEmployeeView = false) {
        let managerHTML = `<div id="${isEmployeeView ? 'employee-machine-manager' : 'owner-machine-manager'}" class="space-y-4">`;
        for(let i = 1; i <= machineConfig.numWashers; i++) {
            const washer = machineStatus.find(m => m.id === `W${i}`);
            const dryer = machineStatus.find(m => m.id === `D${i}`);
            if (!washer || !dryer) continue;

            managerHTML += `
                <div class="p-3 border rounded ${washer.isActive ? 'bg-white' : 'bg-gray-100 opacity-70'}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-lg text-gray-700">Set ${i}</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" onchange="toggleSetStatus(${i})" ${washer.isActive ? 'checked' : ''} class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-semibold ${washer.isActive ? 'text-green-600' : 'text-red-600'}">${washer.isActive ? 'Active' : 'Inactive'}</p>
                    </div>
                    <div class="mt-2 grid grid-cols-2 gap-2 text-center text-sm">
                        <div><p class="font-semibold">${washer.id}</p><p>${washer.cycleCount} cycles</p></div>
                        <div><p class="font-semibold">${dryer.id}</p><p>${dryer.cycleCount} cycles</p></div>
                    </div>
                </div>`;
        }
        managerHTML += `</div>`;
        return managerHTML;
    }
    async function openMachineStatusManager() {
        await Swal.fire({
            title: 'Manage Active Machine Sets',
            html: getMachineManagerHTML(true),
            width: '90%',
            maxWidth: '500px',
            showConfirmButton: true,
            confirmButtonText: 'Done',
        });
    }
    function renderOwnerMachineStatus() { document.getElementById('owner-machine-status-container').innerHTML = getMachineManagerHTML(false); }

    // Note: This function is now part of the processAndSaveOrder batched write for better reliability.
    // It is kept here conceptually, but the actual database operation is now atomic with the order creation.
    async function incrementMachineCyclesForOrder(numLoads) {
        // The logic for choosing which machine to increment is now inside processAndSaveOrder.
        // This function remains empty as a placeholder to avoid breaking any old calls.
    }

    async function saveMachineSettings() {
        const nW = parseInt(document.getElementById('settingNumWashers').value);
        const nD = parseInt(document.getElementById('settingNumDryers').value);
        if (isNaN(nW) || isNaN(nD) || nW <= 0 || nW !== nD) {
            return Swal.fire('Error', 'Please enter a valid, equal number of Washers and Dryers.', 'error');
        }

        const r = await Swal.fire({
            title: 'Confirm Reset',
            text: "Updating machine counts will reset all cycle counts and statuses. Are you sure?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, update and reset!'
        });

        if (r.isConfirmed) {
            machineConfig = { numWashers: nW, numDryers: nD };
            await db.collection(COLLECTIONS.CONFIG).doc('machineConfig').set(machineConfig);
            await initializeMachineStatus();
            Toast.fire({ icon: 'success', title: 'Machine settings saved and counts reset!' });
        }
    }

    function toggleMachineReport() { const c = document.getElementById('machine-usage-report-container'); c.classList.toggle('hidden'); if(!c.classList.contains('hidden')) renderMachineUsageReport(); }
    function renderMachineUsageReport() { const l = document.getElementById('machine-usage-list'); l.innerHTML = ''; if (machineStatus.length === 0) { l.innerHTML = `<p class="text-center text-gray-500">No machines configured.</p>`; return; } machineStatus.filter(m => m.type==='Washer').sort((a,b) => b.cycleCount - a.cycleCount).forEach(w => { const d = machineStatus.find(m => m.id === `D${w.set}`); l.innerHTML += `<div class="flex justify-between p-2 border-b"><span><span class="font-bold">Set ${w.set}</span> (W${w.set}/D${d.set})</span> <span class="font-semibold">${w.cycleCount.toLocaleString()} cycles</span></div>`; }); }

    async function confirmResetAllCycleCounts() {
        const r = await Swal.fire({
            title: 'Reset ALL Cycle Counts?',
            text: 'This action is permanent and cannot be undone!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Yes, Reset All'
        });
        if (r.isConfirmed) {
            await initializeMachineStatus();
            Toast.fire({ icon: 'success', title: 'All cycle counts have been reset to zero.' });
        }
    }

    // --- POS & Order Functions ---
    function debouncedSearchCustomers() {
        clearTimeout(customerSearchTimeout);
        customerSearchTimeout = setTimeout(searchCustomers, 300); // 300ms delay
    }

    function searchCustomers() {
        const nameTerm = allElements.nameEl.value.toLowerCase();
        const phoneTerm = allElements.phoneEl.value.toLowerCase();
        allElements.customerSearchResults.innerHTML = '';
        if (!nameTerm && !phoneTerm) { allElements.customerSearchResults.classList.add('hidden'); return; }
        const matches = shopCustomers.filter(c => (c.name && c.name.toLowerCase().includes(nameTerm)) && (c.phone && c.phone.toLowerCase().includes(phoneTerm)) ).slice(0, 5);
        if (matches.length > 0) {
            allElements.customerSearchResults.classList.remove('hidden');
            matches.forEach(c => {
                const item = document.createElement('div');
                item.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                item.textContent = `${c.name} - ${c.phone}`;
                item.onclick = () => selectCustomer(c.name, c.phone);
                allElements.customerSearchResults.appendChild(item);
            });
        } else { allElements.customerSearchResults.classList.add('hidden'); }
    }

    function selectCustomer(name, phone) { allElements.nameEl.value = name; allElements.phoneEl.value = phone; allElements.customerSearchResults.innerHTML = ''; allElements.customerSearchResults.classList.add('hidden'); }
    function addToCart(label, price, button) { cart.push({ label, price }); renderCart(); if (button) { const oT = button.innerHTML, oC = button.className; button.innerHTML = `<svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Added!`; button.className = oC.replace(/bg-(blue|orange)-500/, 'bg-green-500').replace(/hover:bg-(blue|orange)-600/, ''); button.disabled = true; setTimeout(() => { button.innerHTML = oT; button.className = oC; button.disabled = false; }, 1200); } }

    function addPerKgItemFromInput(id, label, pricePerKg, button) {
        const wE = document.getElementById(`weight-input-${id}`), w = parseFloat(wE.value);
        if (isNaN(w) || w <= 0) return Swal.fire('Invalid Weight', 'Please enter a valid weight.', 'warning');
        addToCart(`${label} (${w}kg)`, w * pricePerKg, button);
        wE.value = '';
    }

    function renderCart() {
        const cE = document.getElementById('cart');
        cE.innerHTML = '';
        let t = 0;
        cart.forEach((i, idx) => { t += i.price; const d = document.createElement('div'); d.className = 'flex justify-between items-center py-1 border-b'; d.innerHTML = `<span>${i.label}</span><div class="flex items-center"><span>₱${i.price.toFixed(2)}</span><button onclick="removeItem(${idx})" class="text-red-500 ml-2 font-bold">&times;</button></div>`; cE.appendChild(d); });
        allElements.totalEl.textContent = t.toFixed(2);
    }
    function removeItem(index) { cart.splice(index, 1); renderCart(); }

    function clearForm() {
        allElements.nameEl.value = '';
        allElements.phoneEl.value = '';
        document.getElementById('orderNotes').value = ''; // Clear notes field
        cart = [];
        renderCart();
        allElements.paymentTypeEl.value = 'collection';
        const sr = document.getElementById('customer-search-results');
        sr.innerHTML = '';
        sr.classList.add('hidden');
        shopServices.forEach(s => { const i = document.getElementById(`weight-input-${s.id}`); if (i) i.value = ''; });
    }

    async function confirmClearForm() { if (cart.length > 0 || allElements.nameEl.value || allElements.phoneEl.value) { const r = await Swal.fire({ title: 'Clear Form?', text: 'All unsaved items will be lost.', icon: 'question', showCancelButton: true, confirmButtonText: 'Yes, Clear' }); if (r.isConfirmed) clearForm(); } }

    async function submitOrder() {
        const name = allElements.nameEl.value.trim();
        const phone = allElements.phoneEl.value.trim().replace(/\D/g, ''); // Sanitize phone number
        const paymentType = allElements.paymentTypeEl.value;
        const notes = document.getElementById('orderNotes').value.trim();
        const total = cart.reduce((s, i) => s + i.price, 0);

        if (!name || cart.length === 0) {
            return Swal.fire('Incomplete Form', 'Customer Name and at least one item are required.', 'warning');
        }

        let cH = `<div class="text-left space-y-2 my-4"><p><strong>Customer:</strong> ${name} (${phone || 'N/A'})</p>${notes ? `<p><strong>Notes:</strong> ${notes}</p>` : ''}<hr class="my-2"><ul class="space-y-1">${cart.map(i => `<li class="flex justify-between"><span>${i.label}</span><span>₱${i.price.toFixed(2)}</span></li>`).join('')}</ul><hr class="my-2"><p class="flex justify-between font-bold text-lg"><span>Total:</span><span>₱${total.toFixed(2)}</span></p></div>`;

        const r = await Swal.fire({
            title: 'Confirm Order Details',
            html: cH,
            icon: 'info',
            showCancelButton: true,
            confirmButtonColor: '#3b82f6',
            confirmButtonText: 'Confirm & Proceed'
        });

        if (r.isConfirmed) {
            let amountPaid = 0;
            let balanceDue = total;
            let change = 0;
            const smsSent = false;

            if (paymentType === 'paid') {
                const amountPaidInput = await getAmountReceived(total, total, 'Amount Received');
                if (amountPaidInput === null) return;
                amountPaid = amountPaidInput;
                balanceDue = 0;
                change = amountPaidInput - total;
            } else if (paymentType === 'down_payment') {
                const downPaymentAmountInput = await getAmountReceived(0.01, total, 'Down Payment Amount');
                if (downPaymentAmountInput === null) return;
                amountPaid = downPaymentAmountInput;
                balanceDue = Math.max(0, total - downPaymentAmountInput);
                change = Math.max(0, downPaymentAmountInput - total);
            }

            // ### OPTIMIZATION: Optimistic UI ###
            const orderData = { name, phone, cart: [...cart], total, paymentType, amountPaid, change, notes, balanceDue, smsSent };

            clearForm(); // Clear the form immediately for a snappy feel
            Toast.fire({icon: 'success', title: 'Order submitted!'});

            // Now, process and save in the background
            processAndSaveOrder(orderData).catch(err => {
                console.error("Failed to save order:", err);
                Swal.fire('Save Failed', 'Could not save the order to the database. Please check your internet connection and try again.', 'error');
            });
        }
    }

    async function processAndSaveOrder(orderData) {
        const { name, phone, cart, total, paymentType, amountPaid, notes, balanceDue, change, smsSent } = orderData;

        const time = dayjs().tz(TIMEZONE).toISOString();
        const orCounterRef = db.collection(COLLECTIONS.CONFIG).doc('orCounter');

        // Get the OR number first using a transaction to prevent race conditions
        const orNumber = await db.runTransaction(async (transaction) => {
            const orCounterDoc = await transaction.get(orCounterRef);
            const newOrValue = (orCounterDoc.exists ? orCounterDoc.data().value : 0) + 1;
            transaction.set(orCounterRef, { value: newOrValue });
            return String(newOrValue).padStart(6, '0');
        });

        const finalTransactionData = {
            ...orderData,
            orNumber: orNumber,
            time: time,
            paymentTimestamp: paymentType !== 'collection' ? time : null,
            _searchableKeywords: [ name.toLowerCase(), phone, orNumber ]
        };

        const batch = db.batch();
        const transactionRef = db.collection(COLLECTIONS.TRANSACTIONS).doc(orNumber);
        batch.set(transactionRef, finalTransactionData);

        if (phone) {
            const customerRef = db.collection(COLLECTIONS.CUSTOMERS).doc(phone);
            batch.set(customerRef, { name, phone }, { merge: true });
        }

        const numLoads = cart.length;
        if (numLoads > 0) {
            let activeWashers = [...machineStatus].filter(m => m.type === 'Washer' && m.isActive);
            if (activeWashers.length > 0) {
                for (let i = 0; i < numLoads; i++) {
                    activeWashers.sort((a, b) => a.cycleCount - b.cycleCount);
                    const chosenWasher = activeWashers[0];
                    chosenWasher.cycleCount++;
                    batch.update(db.collection(COLLECTIONS.MACHINE_STATUS).doc(chosenWasher.id), { cycleCount: firebase.firestore.FieldValue.increment(1) });
                    batch.update(db.collection(COLLECTIONS.MACHINE_STATUS).doc(`D${chosenWasher.set}`), { cycleCount: firebase.firestore.FieldValue.increment(1) });
                }
            }
        }

        await batch.commit();
        showReceipt(finalTransactionData);
    }

    // --- BT --- START OF BLUETOOTH PRINTING LOGIC (UPDATED WITH BUG FIX) ---
    async function saveBluetoothSettings() {
        const isChecked = document.getElementById('swal-auto-print-toggle').checked;
        bluetoothSettings.autoPrint = isChecked;
        await localforage.setItem('bluetooth_settings', bluetoothSettings);
        Toast.fire({ icon: 'success', title: `Auto-Print ${isChecked ? 'Enabled' : 'Disabled'}` });
    }

    class EscPosEncoder {
        constructor() { this._buffer = []; this.encoder = new TextEncoder(); }
        _add(data) { this._buffer.push(...data); }
        initialize() { this._add([0x1B, 0x40]); return this; }
        text(str) { this._add(this.encoder.encode(str)); return this; }

        // --- FIXED --- Added "return this;" to allow for method chaining
        newline(n = 1) {
            for (let i = 0; i < n; i++) this._add([0x0A]);
            return this;
        }

        align(alignment) { const val = { left: 0, center: 1, right: 2 }[alignment]; this._add([0x1B, 0x61, val]); return this; }
        bold(on) { this._add([0x1B, 0x45, on ? 1 : 0]); return this; }
        cut() { this._add([0x1D, 0x56, 1]); return this; }

        qrcode(data, size = 4) {
            const qr = qrcode(0, 'M');
            qr.addData(data);
            qr.make();
            const moduleCount = qr.getModuleCount();
            const store = [0x1d, 0x28, 0x6b, 0x00, 0x00, 0x00, 0x00, 0x31, 0x41, 0x32, 0x00]; // pL, pH, cn, fn, n1, n2
            store[3] = (moduleCount + 3) & 0xff;
            store[4] = ((moduleCount + 3) >> 8) & 0xff;
            this._add([0x1d, 0x28, 0x6b, 0x03, 0x00, 0x31, 0x43, size]); // Model
            this._add([0x1d, 0x28, 0x6b, 0x03, 0x00, 0x31, 0x45, 49]); // Error correction
            this._add(store); // Store data
            this._add(this.encoder.encode(data));
            this._add([0x1d, 0x28, 0x6b, 0x03, 0x00, 0x31, 0x51, 48]); // Print
            return this;
        }

        getBuffer() { return new Uint8Array(this._buffer); }
    }


    function updateBluetoothUI(status = 'disconnected', deviceName = '') {
        const button = allElements.pickupConnectPrinterBtn;
        const text = allElements.pickupPrinterStatusText;

        button.classList.remove('disconnected', 'connecting', 'connected');

        switch(status) {
            case 'connected':
                button.classList.add('connected');
                text.textContent = `Printer: ${deviceName}`;
                break;
            case 'connecting':
                button.classList.add('connecting');
                text.textContent = 'Connecting...';
                break;
            case 'disconnected':
            default:
                button.classList.add('disconnected');
                text.textContent = 'Connect Printer';
                bluetoothDevice = null;
                bluetoothWriteCharacteristic = null;
                break;
        }
    }

    function onBluetoothDisconnected() {
        Toast.fire({ icon: 'warning', title: 'Printer Connection Lost' });
        updateBluetoothUI('disconnected');
    }

    async function openPrinterManagerPopup() {
        const isConnected = bluetoothDevice && bluetoothDevice.gatt.connected;

        await Swal.fire({
            title: 'Printer Connection',
            html: `
                <div id="popup-bt-status" class="mb-4 p-2 rounded text-center font-semibold ${isConnected ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                    Status: ${isConnected ? `Connected to ${bluetoothDevice.name}` : 'Not Connected'}
                </div>
                <label for="swal-auto-print-toggle" class="mt-4 flex justify-between items-center cursor-pointer">
                    <span class="font-medium text-gray-700">Auto-Print Receipts</span>
                    <div class="relative">
                        <input type="checkbox" id="swal-auto-print-toggle" class="sr-only" onchange="saveBluetoothSettings()" ${bluetoothSettings.autoPrint ? 'checked' : ''}>
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                </label>
            `,
            showConfirmButton: true,
            confirmButtonText: isConnected ? 'Test Print' : 'Connect to Printer',
            showDenyButton: isConnected,
            denyButtonText: 'Disconnect',
            showCancelButton: true,
            cancelButtonText: 'Close',
            didOpen: () => {
                const confirmButton = Swal.getConfirmButton();
                const denyButton = Swal.getDenyButton();

                confirmButton.onclick = async () => {
                    if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                        await testBluetoothPrint();
                    } else {
                        Swal.close();
                        await connectBluetoothPrinter();
                    }
                };
                if (denyButton) {
                    denyButton.onclick = async () => {
                        Swal.close();
                        await disconnectBluetoothPrinter();
                    };
                }
            }
        });
    }

    async function connectBluetoothPrinter() {
        let device;
        try {
            Swal.fire({
                title: 'Searching for Printers...',
                text: 'Please select your thermal printer from the list.',
                showConfirmButton: false,
                allowOutsideClick: false,
                willOpen: () => Swal.showLoading()
            });

            device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', 'e7810a71-73ae-499d-8c15-faa9aef0c3f2']
            });

            Swal.update({ title: `Connecting to ${device.name}...`, text: 'Please wait.' });
            await connectToDevice(device);
            Swal.close();

        } catch(error) {
            Swal.close();
            if (error.name === 'NotFoundError') {
                Toast.fire({ icon: 'info', title: 'Device selection cancelled.' });
            } else if (error.name === 'NotSupportedError') {
                Swal.fire('Bluetooth Not Supported', 'Web Bluetooth is not available on this browser. Please use Google Chrome or Microsoft Edge.', 'error');
            } else {
                console.error("Bluetooth connection error:", error);
                Swal.fire('Connection Failed', `An error occurred: ${error.message}`, 'error');
            }
            updateBluetoothUI('disconnected');
        }
    }

    async function connectToDevice(device) {
        console.log('Attempting to connect to:', device.name);
        updateBluetoothUI('connecting');

        let gattServer;
        try {
            device.addEventListener('gattserverdisconnected', onBluetoothDisconnected);

            const controller = new AbortController();
            const timeout = setTimeout(() => {
                controller.abort();
                console.warn('Connection attempt timed out.');
            }, 15000); // 15-second timeout

            gattServer = await device.gatt.connect();
            clearTimeout(timeout);

            Swal.update({ text: 'Discovering services...' });
            const services = await gattServer.getPrimaryServices();

            let characteristic = null;
            const knownServiceUUIDs = ['000018f0-0000-1000-8000-00805f9b34fb', 'e7810a71-73ae-499d-8c15-faa9aef0c3f2'];

            for (const serviceUUID of knownServiceUUIDs) {
                try {
                    const service = await gattServer.getPrimaryService(serviceUUID);
                    const characteristics = await service.getCharacteristics();
                    for (const char of characteristics) {
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            characteristic = char;
                            break;
                        }
                    }
                } catch (e) { /* Service not found, continue */ }
                if (characteristic) break;
            }

            if (!characteristic) {
                for (const service of services) {
                    const characteristics = await service.getCharacteristics();
                    for (const char of characteristics) {
                         if (char.properties.write || char.properties.writeWithoutResponse) {
                            characteristic = char;
                            break;
                        }
                    }
                    if(characteristic) break;
                }
            }

            if (!characteristic) {
                throw new Error("Could not find a writable characteristic on this printer. It might be incompatible.");
            }

            bluetoothDevice = device;
            bluetoothWriteCharacteristic = characteristic;
            Toast.fire({ icon: 'success', title: `Connected to ${device.name}` });
            updateBluetoothUI('connected', device.name);

        } catch (error) {
            console.error("connectToDevice failed:", error);
            if (device && device.gatt && device.gatt.connected) {
                device.gatt.disconnect();
            }
            throw error;
        }
    }

    async function disconnectBluetoothPrinter() {
        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
            bluetoothDevice.gatt.disconnect();
            Toast.fire({ icon: 'info', title: 'Printer disconnected.' });
        } else {
             Toast.fire({ icon: 'info', title: 'Printer was already disconnected.' });
        }
        updateBluetoothUI('disconnected');
    }

    async function sendDataToBluetoothPrinter(data) {
        if (!bluetoothWriteCharacteristic) {
            throw new Error('No printer connected or characteristic not found.');
        }
        const chunkSize = 100;
        const delay = 50;

        try {
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                await bluetoothWriteCharacteristic.writeValueWithoutResponse(chunk);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        } catch (error) {
            console.error("Failed to send data chunk:", error);
            throw new Error(`Failed to send data to printer: ${error.message}`);
        }
    }

    async function testBluetoothPrint() {
        showLoading(true, 'Sending test print...');
        try {
            const encoder = new EscPosEncoder();
            const data = encoder.initialize()
                .align('center')
                .bold(true).text('Printer Test\n').bold(false)
                .text('Connection Successful!\n')
                .text(`${shopSettings.name}\n`)
                .text(`${dayjs().format('YYYY-MM-DD HH:mm')}\n`)
                .newline(2)
                .cut()
                .getBuffer();
            await sendDataToBluetoothPrinter(data);
            Toast.fire({ icon: 'success', title: 'Test print sent!' });
        } catch (error) {
            Swal.fire('Test Print Failed', error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    async function printBluetoothReceipt(tx) {
        if (!tx) return Swal.fire('Error', 'No transaction data to print.', 'error');
        if (!bluetoothWriteCharacteristic) return Swal.fire('Printer Error', 'Bluetooth printer is not connected. Please connect first.', 'error');

        showLoading(true, 'Sending to printer...');
        try {
            const encoder = new EscPosEncoder();
            const itemWidth = 20, priceWidth = 10;

            encoder.initialize()
                   .align('center').bold(true).text(shopSettings.name).newline()
                   .bold(false).text(shopSettings.address).newline()
                   .text(shopSettings.phone).newline(1)
                   .text('------------------------------').newline()
                   .bold(true).text('OFFICIAL RECEIPT').newline(1)
                   .bold(false).align('left')
                   .text(`OR #: ${tx.orNumber}`).newline()
                   .text(`Date: ${dayjs(tx.time).format('MM/DD/YY h:mm A')}`).newline()
                   .text(`Cust: ${tx.name} (${tx.phone || 'N/A'})`).newline(1)
                   .text('------------------------------').newline();

            tx.cart.forEach(item => {
                const label = item.label.length > itemWidth ? item.label.substring(0, itemWidth - 1) + '.' : item.label;
                const price = `P${item.price.toFixed(2)}`;
                encoder.text(`${label.padEnd(itemWidth)}${price.padStart(priceWidth)}`).newline();
            });

            encoder.text('------------------------------').newline()
                   .bold(true).text(`${'TOTAL'.padEnd(itemWidth)}${`P${tx.total.toFixed(2)}`.padStart(priceWidth)}`).newline();

            let paymentStatusLine = '';

            if (tx.paymentType === 'paid' && !tx.balancePaidAmount) { // Fully paid original order
                paymentStatusLine = '*** FULLY PAID ***';
                encoder.align('left')
                       .text(`${'CASH'.padEnd(itemWidth)}${`P${tx.amountPaid.toFixed(2)}`.padStart(priceWidth)}`).newline()
                       .text(`${'CHANGE'.padEnd(itemWidth)}${`P${tx.change.toFixed(2)}`.padStart(priceWidth)}`).newline();
            } else if (tx.paymentType === 'down_payment') {
                paymentStatusLine = '*** DOWN PAYMENT ***';
                encoder.align('left')
                       .text(`${'PAID (DP)'.padEnd(itemWidth)}${`P${tx.amountPaid.toFixed(2)}`.padStart(priceWidth)}`).newline()
                       .text(`${'BALANCE DUE'.padEnd(itemWidth)}${`P${tx.balanceDue.toFixed(2)}`.padStart(priceWidth)}`).newline();
                if (tx.change > 0) {
                    encoder.text(`${'CHANGE'.padEnd(itemWidth)}${`P${tx.change.toFixed(2)}`.padStart(priceWidth)}`).newline();
                }
            } else if (tx.balancePaidAmount) { // This means it was originally a down payment, and now the balance is paid
                paymentStatusLine = '*** BALANCE PAID ***';
                encoder.align('left')
                       .text(`${'BALANCE PAID'.padEnd(itemWidth)}${`P${tx.balancePaidAmount.toFixed(2)}`.padStart(priceWidth)}`).newline();
                if (tx.balanceDue > 0) { // Should be 0 if fully paid
                    encoder.text(`${'REMAINING'.padEnd(itemWidth)}${`P${tx.balanceDue.toFixed(2)}`.padStart(priceWidth)}`).newline();
                }
                if (tx.change > 0) {
                    encoder.text(`${'CHANGE'.padEnd(itemWidth)}${`P${tx.change.toFixed(2)}`.padStart(priceWidth)}`).newline();
                }
                encoder.text(`${'TOTAL COLLECTED'.padEnd(itemWidth)}${`P${(tx.amountPaid).toFixed(2)}`.padStart(priceWidth)}`).newline(); // total amount paid for this order (DP + Balance)
            }
             else { // collection
                paymentStatusLine = '*** FOR COLLECTION ***';
            }

            encoder.align('center').bold(true).text(paymentStatusLine).newline().bold(false);

            if (tx.notes) {
                encoder.align('left').bold(true).text(`Notes: ${tx.notes}`).newline();
            }

            encoder.newline(1).align('center').text('Thank you!');

            if (shopSettings.qrUrl) {
                encoder.newline(1).qrcode(shopSettings.qrUrl, 4);
            }

            encoder.newline(2).cut();

            await sendDataToBluetoothPrinter(encoder.getBuffer());
            if (!bluetoothSettings.autoPrint) { Toast.fire({ icon: 'success', title: 'Receipt sent to printer!' }); }

        } catch (error) {
            console.error("Print failed:", error);
            Swal.fire('Print Failed', `Could not send receipt to printer. Please check the connection. <br><br><b>Error:</b> ${error.message}`, 'error');
            disconnectBluetoothPrinter();
        } finally {
            showLoading(false);
        }
    }
    // --- BT --- END OF BLUETOOTH PRINTING LOGIC ---
    function showReceipt(tx) {
        document.getElementById('receipt-details-compact').innerHTML = `
            OR #: ${tx.orNumber}<br>
            Date: ${dayjs(tx.time).format('MM/DD/YY h:mm A')}<br>
            Cust: ${tx.name} (${tx.phone || 'N/A'})
        `;
        const itemWidth = 20; const priceWidth = 10;
        let itemsHtml = tx.cart.map(item => {
            const label = item.label.length > itemWidth ? item.label.substring(0, itemWidth - 1) + '.' : item.label;
            const price = `₱${item.price.toFixed(2)}`;
            return `<div>${label.padEnd(itemWidth)}${price.padStart(priceWidth)}</div>`;
        }).join('');
        document.getElementById('receipt-items-compact').innerHTML = itemsHtml;
        let summaryHtml = `<div>${'TOTAL'.padEnd(itemWidth)}${`₱${tx.total.toFixed(2)}`.padStart(priceWidth)}</div>`;
        let paymentStatusDisplay = '';
        if (tx.paymentType === 'paid' && !tx.balancePaidAmount) {
            paymentStatusDisplay = 'FULLY PAID';
            summaryHtml += `<div>${'CASH'.padEnd(itemWidth)}${`₱${tx.amountPaid.toFixed(2)}`.padStart(priceWidth)}</div>`;
            summaryHtml += `<div>${'CHANGE'.padEnd(itemWidth)}${`₱${tx.change.toFixed(2)}`.padStart(priceWidth)}</div>`;
        } else if (tx.paymentType === 'down_payment') {
            paymentStatusDisplay = 'DOWN PAYMENT';
            summaryHtml += `<div>${'PAID (DP)'.padEnd(itemWidth)}${`₱${tx.amountPaid.toFixed(2)}`.padStart(priceWidth)}</div>`;
            summaryHtml += `<div>${'BALANCE DUE'.padEnd(itemWidth)}${`₱${tx.balanceDue.toFixed(2)}`.padStart(priceWidth)}</div>`;
            if (tx.change > 0) {
                summaryHtml += `<div>${'CHANGE'.padEnd(itemWidth)}${`₱${tx.change.toFixed(2)}`.padStart(priceWidth)}</div>`;
            }
        } else if (tx.paymentType === 'collection') {
            paymentStatusDisplay = 'FOR COLLECTION';
        } else if (tx.balancePaidAmount) {
            paymentStatusDisplay = 'BALANCE PAID';
            summaryHtml += `<div>${'BALANCE PAID'.padEnd(itemWidth)}${`₱${tx.balancePaidAmount.toFixed(2)}`.padStart(priceWidth)}</div>`;
            if (tx.balanceDue > 0) {
                summaryHtml += `<div>${'REMAINING'.padEnd(itemWidth)}${`₱${tx.balanceDue.toFixed(2)}`.padStart(priceWidth)}</div>`;
            }
            if (tx.change > 0) {
                summaryHtml += `<div>${'CHANGE'.padEnd(itemWidth)}${`₱${tx.change.toFixed(2)}`.padStart(priceWidth)}</div>`;
            }
            summaryHtml += `<div>${'TOTAL COLLECTED'.padEnd(itemWidth)}${`₱${(tx.amountPaid).toFixed(2)}`.padStart(priceWidth)}</div>`;
        }
        summaryHtml += `<div class="font-bold">Payment Status: ${paymentStatusDisplay}</div>`;
        if (tx.notes) {
          summaryHtml += `<div class="font-bold">Notes: ${tx.notes}</div>`;
        }
        document.getElementById('receipt-summary-compact').innerHTML = summaryHtml;
        allElements.receiptQrCode.innerHTML = '';
        if (shopSettings.qrUrl) {
            try {
                const qr = qrcode(0, 'L');
                qr.addData(shopSettings.qrUrl);
                qr.make();
                allElements.receiptQrCode.innerHTML = qr.createImgTag(3, 4);
            } catch (e) { console.error("QR Code generation failed:", e); }
        }
        allElements.btPrintReceiptBtn.classList.toggle('hidden', !bluetoothWriteCharacteristic);
        allElements.btPrintReceiptBtn.onclick = () => printBluetoothReceipt(tx);
        if (bluetoothSettings.autoPrint && bluetoothWriteCharacteristic) {
            printBluetoothReceipt(tx);
        } else {
            allElements.findOrderSection.classList.add('hidden');
            allElements.receiptSection.classList.remove('hidden');
        }
    }
    // --- Reports and Data Management ---
    async function getAmountReceived(minAmount, maxAmount, inputLabel = 'Amount Received') {
        return new Promise(resolve => {
            Swal.fire({
                title: `Total Due: ₱${maxAmount.toFixed(2)}`,
                input: 'number',
                inputLabel: inputLabel,
                inputPlaceholder: 'Enter amount',
                showCancelButton: true,
                confirmButtonText: 'Confirm Payment',
                html: `<div id="swal-change-display"></div>`,
                inputValidator: (value) => {
                    const amount = parseFloat(value);
                    if (isNaN(amount) || amount < minAmount) {
                        return `Amount must be greater than or equal to ₱${minAmount.toFixed(2)}.`;
                    }
                    if (inputLabel === 'Down Payment Amount' && amount > maxAmount) {
                         return `Down payment cannot exceed the total amount of ₱${maxAmount.toFixed(2)}.`;
                    }
                    return null;
                },
                didOpen: () => {
                    const input = Swal.getInput();
                    const changeDisplay = document.getElementById('swal-change-display');
                    input.addEventListener('input', () => {
                        const amount = parseFloat(input.value);
                        if(isNaN(amount)) { changeDisplay.textContent = ''; return; }
                        if (inputLabel === 'Down Payment Amount') {
                            const balance = maxAmount - amount;
                            if (balance >= 0) {
                                changeDisplay.textContent = `Balance Due: ₱${balance.toFixed(2)}`;
                                changeDisplay.className = 'negative';
                            } else {
                                changeDisplay.textContent = `Change: ₱${Math.abs(balance).toFixed(2)}`;
                                changeDisplay.className = 'positive';
                            }
                        } else {
                            const change = amount - maxAmount;
                            if (change >= 0) {
                                changeDisplay.textContent = `Change: ₱${change.toFixed(2)}`;
                                changeDisplay.className = 'positive';
                            } else {
                                changeDisplay.textContent = `Short: ₱${Math.abs(change).toFixed(2)}`;
                                changeDisplay.className = 'negative';
                            }
                        }
                    });
                }
            }).then(result => {
                if (result.isConfirmed) { resolve(parseFloat(result.value)); } else { resolve(null); }
            });
        });
    }

    async function searchTransactions(isButtonClick = false, manageLoading = true) {
        const term = allElements.searchInputEl.value.toLowerCase().trim();
        if (!term) { allElements.searchResultsEl.innerHTML = ''; return; }

        if (manageLoading) showLoading(true);
        allElements.searchResultsEl.innerHTML = '';

        try {
            const query = db.collection(COLLECTIONS.TRANSACTIONS).where('_searchableKeywords', 'array-contains', term).limit(20);
            const snapshot = await query.get();
            let matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            matches.sort((a, b) => new Date(b.time) - new Date(a.time));

            matches.forEach(tx => renderTransaction(tx, allElements.searchResultsEl));
            if(matches.length === 0) { allElements.searchResultsEl.innerHTML = '<p class="text-center text-gray-500 p-4">No matching orders found.</p>'; }

        } catch (error) {
            console.error("Error during searchTransactions:", error);
            Swal.fire('Search Error', `An error occurred during search: ${error.message}`, 'error');
            allElements.searchResultsEl.innerHTML = '<p class="text-center text-red-500 p-4">An error occurred.</p>';
        } finally {
            if (manageLoading) showLoading(false);
        }
    }

    async function openSearchPopup() {
        const { value: searchTerm } = await Swal.fire({
            title: 'Search Order',
            input: 'text',
            inputPlaceholder: 'Enter OR #, Phone, or Name',
            showCancelButton: true,
            confirmButtonText: 'Search',
            showLoaderOnConfirm: true,
            preConfirm: (term) => {
                if (!term || term.trim() === '') {
                    Swal.showValidationMessage('Please enter a search term');
                    return false;
                }
                return term.trim();
            },
            allowOutsideClick: () => !Swal.isLoading()
        });

        if (searchTerm) {
            allElements.searchInputEl.value = searchTerm;
            await searchTransactions(true, true);
        }
    }

    function clearSearch() {
        allElements.searchInputEl.value = '';
        allElements.searchResultsEl.innerHTML = '';
    }

    function renderTransaction(tx, container) {
        const card = document.createElement('div');
        let statusTag, statusTagColor, payButtonHtml = '', smsButtonHtml = '';
        let displayAmount;

        if (tx.balanceDue === undefined) { tx.balanceDue = Math.max(0, tx.total - (tx.amountPaid || 0)); }
        if (tx.smsSent === undefined) tx.smsSent = false;

        if (tx.paymentType === 'paid') {
            statusTag = 'Paid'; statusTagColor = 'bg-green-200 text-green-800'; displayAmount = tx.total.toFixed(2);
        } else if (tx.paymentType === 'down_payment') {
            statusTag = 'Down Payment'; statusTagColor = 'bg-blue-200 text-blue-800';
            displayAmount = `${tx.amountPaid.toFixed(2)} (Bal: ${tx.balanceDue.toFixed(2)})`;
            payButtonHtml = `<button onclick="markAsPaidAndGetAmount('${tx.orNumber}', ${tx.balanceDue}, 'balance_paid')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">Pay Balance</button>`;
        } else {
            statusTag = 'For Collection'; statusTagColor = 'bg-yellow-200 text-yellow-800';
            displayAmount = tx.balanceDue.toFixed(2);
            payButtonHtml = `<button onclick="markAsPaidAndGetAmount('${tx.orNumber}', ${tx.total}, 'paid')" class="bg-blue-500 text-white px-3 py-1 rounded text-xs hover:bg-blue-600">Mark as Paid</button>`;
        }

        if (tx.balanceDue > 0 && shopSettings.smsEnabled && tx.phone) {
             smsButtonHtml = tx.smsSent ? `<button disabled class="bg-gray-300 text-gray-700 px-3 py-1 rounded text-xs ml-2">SMS Sent</button>` : `<button onclick="sendPickupReadySms('${tx.orNumber}', '${tx.phone}', '${tx.name}')" class="bg-purple-500 text-white px-3 py-1 rounded text-xs hover:bg-purple-600 ml-2">Send SMS</button>`;
        }

        card.className = 'p-3 bg-white border rounded shadow-sm mb-2';
        card.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-base">OR#: ${tx.orNumber}</p>
                    <p>${tx.name} - ${tx.phone || 'N/A'}</p>
                    <p class="text-xs text-gray-500">${dayjs(tx.time).format('MMM DD, YYYY - h:mm A')}</p>
                </div>
                <div class="flex flex-col items-end">
                    <p class="font-bold text-lg text-blue-600">₱${displayAmount}</p>
                    <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusTagColor} mt-1">${statusTag}</span>
                </div>
            </div>
            ${tx.notes ? `<p class="mt-2 text-xs italic text-gray-600"><strong>Notes:</strong> ${tx.notes}</p>` : ''}
            <div class="mt-2 text-xs">${tx.cart.map(i => i.label).join(', ')}</div>
            <div class="mt-2 pt-2 border-t flex justify-end gap-2">
                ${payButtonHtml} ${smsButtonHtml}
                <button onclick='showReceipt(${JSON.stringify(tx)})' class="bg-gray-200 px-3 py-1 rounded text-xs hover:bg-gray-300">View Receipt</button>
            </div>
        `;
        container.appendChild(card);
    }

    async function markAsPaidAndGetAmount(orNumber, amountDue, newPaymentType) {
        const inputLabel = (newPaymentType === 'balance_paid') ? 'Amount to Pay Balance' : 'Amount Received';
        const amountPaidInput = await getAmountReceived(amountDue, amountDue, inputLabel);
        if (amountPaidInput === null) return;

        showLoading(true);

        try {
            const change = amountPaidInput - amountDue;
            const txRef = db.collection(COLLECTIONS.TRANSACTIONS).doc(orNumber);
            const currentDoc = await txRef.get();
            if (!currentDoc.exists) throw new Error(`Transaction ${orNumber} not found.`);
            const currentTransaction = currentDoc.data();

            let updatedData = {};
            if (newPaymentType === 'paid') {
                updatedData = {
                    paymentType: 'paid', amountPaid: amountPaidInput, change: change,
                    paymentTimestamp: dayjs().tz(TIMEZONE).toISOString(), balanceDue: 0
                };
            } else if (newPaymentType === 'balance_paid') {
                updatedData = {
                    paymentType: 'paid', amountPaid: currentTransaction.amountPaid + amountPaidInput,
                    balancePaidAmount: amountPaidInput, change: change,
                    paymentTimestamp: dayjs().tz(TIMEZONE).toISOString(), balanceDue: 0
                };
            }

            await txRef.update(updatedData);

            if (allElements.searchInputEl.value) { await searchTransactions(true, false); }
            Toast.fire({ icon: 'success', title: `Order ${orNumber} marked as Paid!` });

        } catch (error) {
            console.error("Error marking as paid:", error);
            Swal.fire('Error', `Failed to mark order as paid: ${error.message}`, 'error');
        } finally {
            showLoading(false);
        }
    }

    async function renderPickupView() {
        const container = allElements.pendingListContainer;
        container.innerHTML = '<div class="inline-loader"></div>';
        const searchTerm = allElements.pickupSearchInput.value.toLowerCase();

        // This query is now handled by the real-time listener, but we can re-fetch for filtering
        const pendingSnapshot = await db.collection(COLLECTIONS.TRANSACTIONS).where('balanceDue', '>', 0).get();
        let activePendingOrders = pendingSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

        if (searchTerm) {
            activePendingOrders = activePendingOrders.filter(tx =>
                tx.name.toLowerCase().includes(searchTerm) ||
                (tx.phone && tx.phone.toLowerCase().includes(searchTerm)) ||
                tx.orNumber.toLowerCase().includes(searchTerm)
            );
        }

        container.innerHTML = '';

        if (activePendingOrders.length === 0) {
            const message = searchTerm ? `No pending orders match your filter.` : `No orders for collection.`;
            container.innerHTML = `<p class="text-center text-gray-500 p-4">${message}</p>`;
            return;
        }

        activePendingOrders.sort((a, b) => new Date(a.time) - new Date(b.time)).forEach(tx => renderPickupCard(tx, container));
    }

    function getColorForText(str) {
        if (!str) return 'text-gray-700';
        const colors = [ 'text-red-700', 'text-green-700', 'text-blue-700', 'text-indigo-700', 'text-purple-700', 'text-pink-700', 'text-teal-700', 'text-orange-800' ];
        let hash = 0;
        for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
        return colors[Math.abs(hash % colors.length)];
    }

    function renderPickupCard(tx, container) {
        const card = document.createElement('div');
        const timeObj = dayjs(tx.time);
        let displayTime, timeSuffix = ' ago';
        if (typeof timeObj.fromNow === 'function') { displayTime = timeObj.fromNow(true); }
        else { displayTime = timeObj.format('MMM DD, YYYY'); timeSuffix = ''; }

        let bgColor, statusTag, statusTagColor, totalDisplay, payButton, smsButtonHtml = '';
        const customerNameColor = getColorForText(tx.name);

        if (tx.balanceDue === undefined) tx.balanceDue = Math.max(0, tx.total - (tx.amountPaid || 0));
        if (tx.smsSent === undefined) tx.smsSent = false;

        if (tx.paymentType === 'down_payment') {
            bgColor = 'bg-blue-50 border-blue-200'; statusTag = 'Down Payment'; statusTagColor = 'bg-blue-200 text-blue-800';
            totalDisplay = `₱${tx.amountPaid.toFixed(2)} (Bal: ₱${tx.balanceDue.toFixed(2)})`;
            payButton = `<button onclick="markAsPaidAndGetAmount('${tx.orNumber}', ${tx.balanceDue}, 'balance_paid')" class="bg-blue-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-blue-600">Pay Balance</button>`;
        } else {
            bgColor = 'bg-yellow-50 border-yellow-200'; statusTag = 'For Collection'; statusTagColor = 'bg-yellow-200 text-yellow-800';
            totalDisplay = `₱${tx.balanceDue.toFixed(2)}`;
            payButton = `<button onclick="markAsPaidAndGetAmount('${tx.orNumber}', ${tx.total}, 'paid')" class="bg-blue-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-blue-600">Mark as Paid</button>`;
        }

        if (shopSettings.smsEnabled && tx.phone) {
            smsButtonHtml = tx.smsSent ? `<button disabled class="bg-gray-300 text-gray-700 px-4 py-2 rounded text-sm ml-2">SMS Sent</button>` : `<button onclick="sendPickupReadySms('${tx.orNumber}', '${tx.phone}', '${tx.name}')" class="bg-purple-500 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-purple-600 ml-2">Send SMS</button>`;
        }

        card.className = `p-4 border rounded-lg shadow-sm ${bgColor}`;
        card.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between gap-4">
                <div>
                    <div class="flex items-baseline gap-2">
                        <p class="font-bold text-lg">OR# ${tx.orNumber}</p>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusTagColor}">${statusTag}</span>
                    </div>
                    <p class="text-base"><span class="font-bold text-lg ${customerNameColor}">${tx.name}</span> <span class="font-normal text-gray-600">(${tx.phone || 'No Phone'})</span></p>
                    <p class="text-sm text-gray-500">Dropped off: ${displayTime}${timeSuffix}</p>
                    ${tx.notes ? `<p class="mt-2 text-sm italic text-gray-700"><strong>Notes:</strong> ${tx.notes}</p>` : ''}
                </div>
                <div class="flex flex-col items-start md:items-end">
                    <p class="font-bold text-2xl mb-2">${totalDisplay}</p>
                    <div class="flex items-center gap-2 flex-wrap justify-end">
                        ${payButton} ${smsButtonHtml}
                        <button onclick='showReceipt(${JSON.stringify(tx)})' class="bg-gray-200 p-2 rounded hover:bg-gray-300" title="View Receipt">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>`;
        container.appendChild(card);
    }

    async function generateEndOfDayReport() {
        showLoading(true);
        const totalCollectedToday = await getTotalCollectedToday();

        const todayStart = dayjs().tz(TIMEZONE).startOf('day').toDate();
        const todayEnd = dayjs().tz(TIMEZONE).endOf('day').toDate();
        const todaySnapshot = await db.collection(COLLECTIONS.TRANSACTIONS).where('time', '>=', todayStart.toISOString()).where('time', '<=', todayEnd.toISOString()).get();
        const totalSalesToday = todaySnapshot.docs.reduce((sum, doc) => sum + doc.data().total, 0);

        const pendingSnapshot = await db.collection(COLLECTIONS.TRANSACTIONS).where('balanceDue', '>', 0).get();
        const forCollectionCount = pendingSnapshot.size;
        const totalValueForCollection = pendingSnapshot.docs.reduce((sum, doc) => sum + doc.data().balanceDue, 0);

        const reportHtml = `
            <div class="text-left space-y-3">
                <p class="text-2xl font-bold">End of Day Report</p>
                <p class="text-sm text-gray-500">${dayjs().tz(TIMEZONE).format('MMMM D, YYYY')}</p><hr>
                <p class="flex justify-between"><span>Total Collected Revenue (Cash on Hand):</span> <span class="font-bold text-xl">₱${totalCollectedToday.toFixed(2)}</span></p>
                <p class="flex justify-between"><span>Total Sales (Orders Created Today):</span> <span class="font-bold text-xl">₱${totalSalesToday.toFixed(2)}</span></p><hr>
                <p class="flex justify-between"><span>Orders for Collection / Has Balance:</span> <span class="font-bold">${forCollectionCount} orders</span></p>
                <p class="flex justify-between"><span>Outstanding Balance Total:</span> <span class="font-bold text-xl">₱${totalValueForCollection.toFixed(2)}</span></p>
            </div>`;
        showLoading(false);
        Swal.fire({ title: 'Daily Summary', html: reportHtml, confirmButtonText: 'Great!' });
    }

    function toggleDailyReport() {
        const btn = document.getElementById('daily-report-btn'), list = document.getElementById('salesList');
        if (list.style.display === 'none') {
            generateDailyReport(); list.style.display = 'block'; btn.textContent = 'Hide Daily Details';
        } else {
            list.style.display = 'none'; btn.textContent = 'View Daily Details';
        }
    }

    async function generateDailyReport() {
        showLoading(true);
        const dateKey = allElements.reviewDateEl.value;
        const dayStart = dayjs(dateKey).startOf('day').toISOString();
        const dayEnd = dayjs(dateKey).endOf('day').toISOString();
        const snapshot = await db.collection(COLLECTIONS.TRANSACTIONS).where('time', '>=', dayStart).where('time', '<=', dayEnd).get();
        const dailyData = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

        const container = allElements.salesListEl;
        container.innerHTML = '';
        if (dailyData.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 p-4">No sales on ${dateKey}.</p>`;
            showLoading(false); return;
        }
        const total = dailyData.reduce((sum, tx) => sum + tx.total, 0);
        container.innerHTML = `<p class="font-bold text-lg p-2 bg-gray-100 rounded">Total for ${dateKey}: ₱${total.toFixed(2)}</p>`;
        dailyData.forEach(tx => renderTransaction(tx, container));
        showLoading(false);
    }

    async function openCustomerPromoManager() {
        showLoading(true, 'Fetching customers...');
        if (!shopSettings.smsApiUrl || !shopSettings.smsPickupMessageTemplate) {
            showLoading(false);
            return Swal.fire('SMS Not Configured', 'Please set up SMS API URL and message template in Owner Settings > Shop Config.', 'warning');
        }
        const customersWithPhones = shopCustomers.filter(c => c && c.phone && /^\d+$/.test(c.phone));
        if (customersWithPhones.length === 0) {
            showLoading(false);
            return Swal.fire('No Customers Found', 'No customers with valid phone numbers in the database.', 'info');
        }
        const modalHtml = `<div class="text-left space-y-4"><p>Send a promotional message to <strong class="text-indigo-600">${customersWithPhones.length} customers</strong>.</p><div><label for="promo-message-input" class="font-semibold block mb-1">Your Message:</label><textarea id="promo-message-input" rows="4" class="border p-2 w-full rounded" placeholder="Type your promo message..."></textarea><p class="text-xs text-gray-500 mt-1"><code>[Shop Name]</code> will be replaced.</p></div></div>`;
        showLoading(false);
        const { value: message } = await Swal.fire({
            title: 'Customer Promo SMS', html: modalHtml, width: '90%', maxWidth: '600px', showCancelButton: true,
            confirmButtonText: 'Send to All Customers', confirmButtonColor: '#4f46e5',
            preConfirm: () => {
                const msg = document.getElementById('promo-message-input').value;
                if (!msg || msg.trim() === '') { Swal.showValidationMessage('Message cannot be empty.'); return false; }
                return msg;
            }
        });
        if (message) {
            const { isConfirmed } = await Swal.fire({
                title: 'Are you absolutely sure?', text: `This will send an SMS to ${customersWithPhones.length} customers.`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Yes, Send It!',
            });
            if (isConfirmed) await sendSmsBlast(customersWithPhones, message);
        }
    }

    async function sendSinglePromoMessage(customer, message) {
        try {
            const encodedMessage = encodeURIComponent(message);
            const apiUrl = `${shopSettings.smsApiUrl}n=${customer.phone}&t=${encodedMessage}`;
            const response = await fetch(apiUrl);
            if (response.ok) {
                const responseData = await response.json().catch(() => ({}));
                return { success: responseData.status === 'success' || responseData.success, log: `✔ API Accepted: ${customer.name} (${customer.phone})` };
            }
            return { success: false, log: `✖ API Error: ${customer.name} (${customer.phone}) - Status ${response.status}` };
        } catch (error) {
            return { success: false, log: `✖ Network Error: ${customer.name} (${customer.phone})` };
        }
    }

    async function sendSmsBlast(customers, message) {
        Swal.fire({
            title: 'Sending Promo...',
            html: `<div class="text-left space-y-4"><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="promo-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div><p id="promo-progress-text" class="text-center font-semibold"></p><div class="mt-4"><label class="font-semibold block mb-1">Send Log:</label><textarea id="promo-log-area" readonly class="border p-2 w-full h-40 bg-gray-100 font-mono text-xs"></textarea></div></div>`,
            allowOutsideClick: false, showConfirmButton: false,
            willOpen: async () => {
                Swal.showLoading();
                const bar = document.getElementById('promo-progress-bar'), text = document.getElementById('promo-progress-text'), log = document.getElementById('promo-log-area');
                let s = 0, f = 0;
                const msg = message.replace(/\[Shop Name\]/g, shopSettings.name);
                for (let i = 0; i < customers.length; i++) {
                    text.textContent = `Sending to ${customers[i].name}... (${i + 1}/${customers.length})`;
                    const result = await sendSinglePromoMessage(customers[i], msg);
                    log.value += result.log + '\n'; log.scrollTop = log.scrollHeight;
                    result.success ? s++ : f++;
                    bar.style.width = `${((i + 1) / customers.length) * 100}%`;
                    if (i < customers.length - 1) await new Promise(res => setTimeout(res, 1000));
                }
                Swal.fire({
                    title: 'Promo Send Complete!', icon: 'info',
                    html: `<div class="text-left"><p><strong>Sent Successfully:</strong> ${s}</p><p><strong>Failed:</strong> ${f}</p></div>`
                });
            }
        });
    }

    // UPDATED to fetch data from Firestore for reports
    async function getSalesDataForPeriod(startDate, endDate) {
        const snapshot = await db.collection(COLLECTIONS.TRANSACTIONS)
                                 .where('time', '>=', startDate.toISOString())
                                 .where('time', '<=', endDate.toISOString())
                                 .get();
        return snapshot.docs.map(doc => doc.data());
    }

    async function getCollectedDataForPeriod(startDate, endDate) {
        const dailyCollected = {};
        const snapshot = await db.collection(COLLECTIONS.TRANSACTIONS)
                               .where('paymentTimestamp', '>=', startDate.toISOString())
                               .where('paymentTimestamp', '<=', endDate.toISOString())
                               .get();

        snapshot.docs.forEach(doc => {
            const tx = doc.data();
            const paymentDateKey = dayjs(tx.paymentTimestamp).tz(TIMEZONE).format('YYYY-MM-DD');
            if (!dailyCollected[paymentDateKey]) dailyCollected[paymentDateKey] = 0;

            if (tx.balancePaidAmount) dailyCollected[paymentDateKey] += tx.balancePaidAmount;
            else if (tx.paymentType === 'down_payment') dailyCollected[paymentDateKey] += tx.amountPaid;
            else if (tx.paymentType === 'paid') dailyCollected[paymentDateKey] += tx.total;
        });
        return dailyCollected;
    }

    async function generateExcelReport() {
        const startDateStr = document.getElementById('reportStartDate').value;
        const endDateStr = document.getElementById('reportEndDate').value;
        if (!startDateStr || !endDateStr) return Swal.fire('Missing Date', 'Please select a start and end date.', 'warning');

        showLoading(true, 'Generating Report...');
        try {
            const startDate = dayjs(startDateStr).startOf('day'), endDate = dayjs(endDateStr).endOf('day');
            const salesData = await getSalesDataForPeriod(startDate, endDate);
            if (salesData.length === 0) { showLoading(false); return Swal.fire('No Data', 'No sales data found for the selected period.', 'info'); }

            const detailedRows = [], serviceRevenue = {};
            salesData.forEach(tx => {
                tx.cart.forEach(item => {
                    const baseLabel = item.label.split(' (')[0];
                    if (!serviceRevenue[baseLabel]) serviceRevenue[baseLabel] = { revenue: 0, count: 0 };
                    serviceRevenue[baseLabel].revenue += item.price;
                    serviceRevenue[baseLabel].count++;
                    detailedRows.push({ "OR #": tx.orNumber, "Date": tx.time, "Customer": tx.name, "Phone": tx.phone, "Item": item.label, "Price": item.price, "Order Total": tx.total, "Payment": tx.paymentType, "Paid (Total)": tx.amountPaid, "DP Amount": tx.paymentType==='down_payment' ? tx.amountPaid : 0, "Balance Paid": tx.balancePaidAmount||0, "Balance Due": tx.balanceDue||0, "Change": tx.change||0, "Pay Date": tx.paymentTimestamp||'N/A', "SMS Sent": tx.smsSent?'Yes':'No', "Notes": tx.notes||'' });
                });
            });

            const totalSales = salesData.reduce((s,tx)=>s+tx.total,0), collectedInPeriod = Object.values(await getCollectedDataForPeriod(startDate,endDate)).reduce((s,a)=>s+a,0);
            const summaryData = [
                { Metric: "Period", Value: `${startDateStr} to ${endDateStr}` },
                { Metric: "Total Sales Revenue", Value: `₱${totalSales.toFixed(2)}` },
                { Metric: "Total Collected (in period)", Value: `₱${collectedInPeriod.toFixed(2)}` },
                { Metric: "Total Orders", Value: salesData.length },
                {}, { Metric: "--- Service Breakdown ---" },
            ];
            Object.entries(serviceRevenue).sort((a,b)=>b[1].revenue-a[1].revenue).forEach(([l,d])=>{ summaryData.push({Metric:`${l} (Sales)`,Value:`₱${d.revenue.toFixed(2)}`}); summaryData.push({Metric:`${l} (Count)`,Value:d.count}); });

            const wb = XLSX.utils.book_new(), wsDetails = XLSX.utils.json_to_sheet(detailedRows), wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Summary"); XLSX.utils.book_append_sheet(wb, wsDetails, "Detailed Sales");
            wsDetails["!cols"] = [ {wch:10}, {wch:18}, {wch:20}, {wch:15}, {wch:25}, {wch:10}, {wch:12}, {wch:12}, {wch:18}, {wch:18}, {wch:18}, {wch:12}, {wch:12}, {wch:18}, {wch:10}, {wch:30} ];
            wsSummary["!cols"] = [ {wch:40}, {wch:25} ];
            XLSX.writeFile(wb, `Laundry_Report_${startDateStr}_to_${endDateStr}.xlsx`);
            showLoading(false);
            Toast.fire({ icon: 'success', title: 'Report generated!' });
        } catch (error) { showLoading(false); console.error("Excel report failed:", error); Swal.fire('Error', 'Failed to generate report.', 'error'); }
    }
    
    // This is the new master function that gets the month from the input and calls the report generator.
    async function generateNewMonthlyReport() {
        const reportMonthInput = document.getElementById('reportMonth');
        if (!reportMonthInput.value) {
            return Swal.fire('Error', 'Please select a month and year to generate a report.', 'warning');
        }
        
        const container = document.getElementById('monthly-report-output');
        showLoading(true, `Generating report for ${dayjs(reportMonthInput.value).format("MMMM YYYY")}...`);
        
        await generateMonthlyReport(reportMonthInput.value); // Pass the selected month
        
        container.classList.remove('hidden');
        showLoading(false);
    }

    // This is the new, upgraded report generation logic.
    async function generateMonthlyReport(selectedMonth) { // Now accepts a month parameter
        const now = dayjs(selectedMonth).tz(TIMEZONE);
        const currentMonthStart = now.startOf('month');
        const currentMonthEnd = now.endOf('month');
        const prevMonthStart = now.subtract(1, 'month').startOf('month');
        const prevMonthEnd = now.subtract(1, 'month').endOf('month');
        const prevYearMonthStart = now.subtract(1, 'year').startOf('month');
        const prevYearMonthEnd = now.subtract(1, 'year').endOf('month');

        // Update report title
        document.getElementById('monthly-report-title').textContent = `Monthly Report for ${now.format("MMMM YYYY")}`;

        const [currentMonthSales, prevMonthSales, prevYearMonthSales, collectedDataMap] = await Promise.all([
            getSalesDataForPeriod(currentMonthStart, currentMonthEnd),
            getSalesDataForPeriod(prevMonthStart, prevMonthEnd),
            getSalesDataForPeriod(prevYearMonthStart, prevYearMonthEnd),
            getCollectedDataForPeriod(currentMonthStart, currentMonthEnd)
        ]);

        // --- KPI Calculations ---
        const totalCollected = Object.values(collectedDataMap).reduce((sum, val) => sum + val, 0);
        const currentTotalSales = currentMonthSales.reduce((s, t) => s + t.total, 0);
        const currentTotalOrders = currentMonthSales.length;
        const currentAvgSale = currentTotalOrders > 0 ? currentTotalSales / currentTotalOrders : 0;
        const netProfit = totalCollected - currentTotalSales;

        document.getElementById('monthlyTotalCollected').textContent = `₱${totalCollected.toFixed(2)}`;
        document.getElementById('monthlyTotalSales').textContent = `₱${currentTotalSales.toFixed(2)}`;
        document.getElementById('monthlyNet').textContent = `₱${netProfit.toFixed(2)}`;
        document.getElementById('monthlyNet').className = `text-2xl font-bold ${netProfit >= 0 ? 'text-green-900' : 'text-red-900'}`;
        document.getElementById('monthlyTotalOrders').textContent = currentTotalOrders.toLocaleString();
        document.getElementById('monthlyAvgSale').textContent = `₱${currentAvgSale.toFixed(2)}`;

        // --- Comparison Calculations ---
        const prevMonthTotalSales = prevMonthSales.reduce((s, t) => s + t.total, 0);
        const prevYearMonthTotalSales = prevYearMonthSales.reduce((s, t) => s + t.total, 0);
        const renderComparison = (c, p) => {
            if (p === 0) return `<span class="text-gray-500">N/A (No prior data)</span>`;
            const diff = ((c - p) / p) * 100;
            return `<span class="${diff >= 0 ? 'text-green-600' : 'text-red-600'}">${diff >= 0 ? '▲' : '▼'} ${Math.abs(diff).toFixed(1)}%</span> vs ₱${p.toFixed(2)}`;
        };
        document.getElementById('vsPrevMonth').innerHTML = renderComparison(currentTotalSales, prevMonthTotalSales);
        document.getElementById('vsPrevYear').innerHTML = renderComparison(currentTotalSales, prevYearMonthTotalSales);

        // --- Weekly Performance Analysis ---
        const dayOfWeekSales = { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0 }; // Sun-Sat
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        currentMonthSales.forEach(tx => {
            const dayIndex = dayjs(tx.time).tz(TIMEZONE).day();
            dayOfWeekSales[dayIndex] += tx.total;
        });
        let busiestDayIndex = -1, quietestDayIndex = -1;
        let maxSales = -1, minSales = Infinity;
        for (let i = 0; i < 7; i++) {
            if (dayOfWeekSales[i] > maxSales) { maxSales = dayOfWeekSales[i]; busiestDayIndex = i; }
            if (dayOfWeekSales[i] < minSales) { minSales = dayOfWeekSales[i]; quietestDayIndex = i; }
        }
        document.getElementById('busiestDay').textContent = dayNames[busiestDayIndex];
        document.getElementById('quietestDay').textContent = dayNames[quietestDayIndex];

        // --- Chart Generation ---
        const daysInMonth = now.daysInMonth();
        const dailySales = new Array(daysInMonth).fill(0);
        const chartLabels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
        currentMonthSales.forEach(tx => { dailySales[dayjs(tx.time).tz(TIMEZONE).date() - 1] += tx.total; });
        if (monthlyChartInstance) monthlyChartInstance.destroy();
        monthlyChartInstance = new Chart(document.getElementById('monthlySalesChart').getContext('2d'), {
            type: 'line',
            data: { labels: chartLabels, datasets: [{ label: 'Daily Sales (₱)', data: dailySales, borderColor: 'rgb(124,58,237)', backgroundColor: 'rgba(124,58,237,0.1)', tension: 0.1, fill: true }] },
            options: { scales: { y: { beginAtZero: true } } }
        });

        // --- Top Services Analysis ---
        const serviceRevenue = {};
        currentMonthSales.forEach(tx => tx.cart.forEach(item => {
            const label = item.label.split(' (')[0];
            if (!serviceRevenue[label]) serviceRevenue[label] = { revenue: 0, count: 0 };
            serviceRevenue[label].revenue += item.price;
            serviceRevenue[label].count++;
        }));
        const topServices = Object.entries(serviceRevenue).sort((a, b) => b[1].revenue - a[1].revenue).slice(0, 5);
        const topServicesContainer = document.getElementById('top-services-list');
        topServicesContainer.innerHTML = topServices.length > 0 ? topServices.map(([label, data]) => {
            const percentage = currentTotalSales > 0 ? (data.revenue / currentTotalSales * 100).toFixed(1) : 0;
            return `<div class="p-2 bg-gray-50 rounded">
                        <div class="flex justify-between items-center font-semibold"><span>${label}</span><span>₱${data.revenue.toFixed(2)}</span></div>
                        <div class="text-xs text-gray-500 flex justify-between"><span>${data.count} orders</span><span>${percentage}% of Sales</span></div>
                    </div>`;
        }).join('') : `<p class="text-center text-gray-500 p-2">No services sold this month.</p>`;

        // --- Top Customers Analysis ---
        const customerSpending = {};
        currentMonthSales.forEach(tx => {
            if (tx.name) {
                if (!customerSpending[tx.name]) customerSpending[tx.name] = 0;
                customerSpending[tx.name] += tx.total;
            }
        });
        const topCustomers = Object.entries(customerSpending).sort((a, b) => b[1] - a[1]).slice(0, 5);
        const topCustomersContainer = document.getElementById('top-customers-list');
        topCustomersContainer.innerHTML = topCustomers.length > 0 ? topCustomers.map(([name, total]) =>
            `<div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                <span class="font-semibold">${name}</span>
                <span>₱${total.toFixed(2)}</span>
            </div>`
        ).join('') : `<p class="text-center text-gray-500 p-2">No customer data for this month.</p>`;


        // --- Daily Breakdown Table ---
        const dailyBreakdown = {};
        const tableContainer = document.getElementById('daily-breakdown-table');
        for (let i = 1; i <= daysInMonth; i++) dailyBreakdown[i] = { sales: 0, orders: 0, collected: 0 };
        currentMonthSales.forEach(tx => { const d = dayjs(tx.time).tz(TIMEZONE).date(); dailyBreakdown[d].sales += tx.total; dailyBreakdown[d].orders++; });
        for (const [dateKey, amount] of Object.entries(collectedDataMap)) { const d = dayjs(dateKey).date(); if (dailyBreakdown[d]) dailyBreakdown[d].collected = amount; }
        let tableHtml = `<table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-2">Date</th><th class="px-4 py-2 text-right">Orders</th><th class="px-4 py-2 text-right">Total Sales</th><th class="px-4 py-2 text-right">Collected (Cash)</th></tr></thead><tbody>`;
        for (let i = daysInMonth; i >= 1; i--) {
            tableHtml += `<tr class="bg-white border-b"><td class="px-4 py-2 font-medium">${now.format('MMM')} ${i}</td><td class="px-4 py-2 text-right">${dailyBreakdown[i].orders}</td><td class="px-4 py-2 text-right">₱${dailyBreakdown[i].sales.toFixed(2)}</td><td class="px-4 py-2 text-right font-semibold">₱${dailyBreakdown[i].collected.toFixed(2)}</td></tr>`;
        }
        tableHtml += '</tbody></table>';
        tableContainer.innerHTML = tableHtml;
    }

    async function backupData() {
        showLoading(true, "Backing up all cloud data...");
        const backupData = {
            services: [], customers: [], transactions: [],
            config: {}, machineStatus: []
        };
        const servicesSnap = await db.collection(COLLECTIONS.SERVICES).get(); backupData.services = servicesSnap.docs.map(d => ({...d.data(), id: d.id}));
        const customersSnap = await db.collection(COLLECTIONS.CUSTOMERS).get(); backupData.customers = customersSnap.docs.map(d => d.data());
        const transactionsSnap = await db.collection(COLLECTIONS.TRANSACTIONS).get(); backupData.transactions = transactionsSnap.docs.map(d => d.data());
        const machineStatusSnap = await db.collection(COLLECTIONS.MACHINE_STATUS).get(); backupData.machineStatus = machineStatusSnap.docs.map(d => d.data());
        const configSnap = await db.collection(COLLECTIONS.CONFIG).get(); configSnap.forEach(d => backupData.config[d.id] = d.data());
        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(backupData, null, 2)], {type: "application/json"})); a.download = `laundry_pos_backup_${dayjs().format('YYYY-MM-DD')}.json`; a.click(); URL.revokeObjectURL(a.href);
        showLoading(false);
        Toast.fire({icon: 'success', title: 'Cloud backup downloaded!'});
    }

    function triggerRestore() { Swal.fire({ title: 'Restore Data to Cloud?', text: 'This will overwrite ALL cloud data.', icon: 'warning', input: 'file', inputAttributes:{'accept':'application/json'}, showCancelButton:true, confirmButtonText:'Upload & Restore', confirmButtonColor:'#d33', }).then(r => r.isConfirmed && r.value && restoreData(r.value)); }

    // =======================================================================
    // ### THIS IS THE NEW, CORRECTED FUNCTION THAT FIXES THE "STUCK" ISSUE ###
    // =======================================================================
    async function restoreData(file) {
        showLoading(true, "Reading backup file...");
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                let dataToRestore = JSON.parse(e.target.result);

                if (dataToRestore.global_or_counter !== undefined || dataToRestore.shop_customers !== undefined) {
                    showLoading(true, "Old backup detected. Converting...");
                    Toast.fire({icon: 'info', title: 'Old backup detected, converting...'});
                    dataToRestore = transformOldBackupToNewFormat(dataToRestore);
                }

                showLoading(true, "Starting restore...");

                // Helper function to commit data in chunks under 500 operations
                const commitBatchInChunks = async (collectionName, data, idField) => {
                    let batch = db.batch();
                    let operationCount = 0;
                    const totalItems = data.length;

                    for (let i = 0; i < totalItems; i++) {
                        const item = data[i];
                        const docId = item[idField];
                        if (!docId) {
                            console.warn(`Skipping item in ${collectionName} due to missing ID:`, item);
                            continue;
                        }
                        const docRef = db.collection(collectionName).doc(String(docId));
                        batch.set(docRef, item);
                        operationCount++;

                        // Update UI feedback every 25 items for better responsiveness
                        if (i % 25 === 0) {
                           showLoading(true, `Restoring ${collectionName}... (${i + 1}/${totalItems})`);
                        }

                        // Commit batch when it's full and start a new one
                        if (operationCount >= 499) {
                            await batch.commit();
                            batch = db.batch();
                            operationCount = 0;
                        }
                    }

                    // Commit any remaining operations in the final batch
                    if (operationCount > 0) {
                        await batch.commit();
                    }
                };

                // Restore large collections in chunks
                if (dataToRestore.services?.length) await commitBatchInChunks(COLLECTIONS.SERVICES, dataToRestore.services, 'id');
                if (dataToRestore.customers?.length) await commitBatchInChunks(COLLECTIONS.CUSTOMERS, dataToRestore.customers, 'id');
                if (dataToRestore.transactions?.length) await commitBatchInChunks(COLLECTIONS.TRANSACTIONS, dataToRestore.transactions, 'orNumber');

                // Restore small collections in a single batch
                showLoading(true, "Finalizing configuration...");
                const finalBatch = db.batch();
                dataToRestore.machineStatus?.forEach(m => finalBatch.set(db.collection(COLLECTIONS.MACHINE_STATUS).doc(m.id), m));
                if (dataToRestore.config) {
                    Object.entries(dataToRestore.config).forEach(([key, val]) => finalBatch.set(db.collection(COLLECTIONS.CONFIG).doc(key), val));
                }
                await finalBatch.commit();

                Swal.fire('Success!', 'Data restored successfully. The application will now reload.', 'success').then(() => location.reload());

            } catch (err) {
                console.error("Restore failed:", err);
                Swal.fire('Error', `Restore failed. Error: ${err.message}`, 'error');
            } finally {
                showLoading(false);
            }
        };
        reader.readAsText(file);
    }

    function transformOldBackupToNewFormat(oldData) {
        const newData = {
            services: [], customers: [], transactions: [],
            config: {}, machineStatus: []
        };

        if (Array.isArray(oldData.shop_services)) {
            newData.services = oldData.shop_services
                .filter(s => s && typeof s.label === 'string' && s.label.trim() !== '')
                .map(s => {
                    const id = s.id ? String(s.id) : s.label.trim().replace(/\s+/g, '_').replace(/[^\w-]/g, '');
                    return { ...s, id: id };
                });
        }

        if (Array.isArray(oldData.shop_customers)) {
            newData.customers = oldData.shop_customers
                .filter(c => c && c.name)
                .map(c => {
                    const phone = c.phone || "";
                    const invalidPhoneValues = ["none", "n", "n.", "no"];
                    const isValidPhone = typeof phone === 'string' && phone.trim().length > 3 && !invalidPhoneValues.includes(phone.toLowerCase().trim());
                    const id = isValidPhone ? phone : String(c.id);
                    return { ...c, id: id };
                });
        }

        newData.machineStatus = oldData.machine_status || [];
        newData.config.shopSettings = oldData.shop_settings || {};
        newData.config.orCounter = { value: oldData.global_or_counter || 0 };
        newData.config.appPassword = { value: oldData.app_password || 'root' };
        newData.config.machineConfig = oldData.machine_config || { numWashers: 2, numDryers: 2 };

        const transactionMap = new Map();
        for (const key in oldData) {
            if (/^\d{4}-\d{2}-\d{2}$/.test(key)) {
                if (Array.isArray(oldData[key])) {
                    oldData[key].forEach(tx => {
                        if (tx && tx.orNumber) transactionMap.set(tx.orNumber, tx);
                    });
                }
            }
        }

        if (oldData.pending_pickups) {
            const pending = Array.isArray(oldData.pending_pickups)
                ? oldData.pending_pickups
                : Object.values(oldData.pending_pickups);
            pending.forEach(tx => {
                if (tx && tx.orNumber) transactionMap.set(tx.orNumber, tx);
            });
        }

        newData.transactions = Array.from(transactionMap.values()).map(tx => {
            let calculatedBalanceDue = 0;
            if (tx.paymentType === 'collection') {
                calculatedBalanceDue = tx.total;
            } else {
                calculatedBalanceDue = 0;
            }

            const invalidPhoneValues = ["none", "n", "n.", "no"];
            let cleanPhone = tx.phone || "";
            if (typeof cleanPhone === 'string' && invalidPhoneValues.includes(cleanPhone.toLowerCase().trim())) {
                cleanPhone = "";
            }

            return {
                ...tx,
                phone: cleanPhone,
                balanceDue: calculatedBalanceDue,
                smsSent: tx.smsSent || false,
                notes: tx.notes || "",
                _searchableKeywords: [
                    (tx.name || "").toLowerCase(),
                    cleanPhone,
                    tx.orNumber || ""
                ].filter(Boolean)
            };
        });

        console.log(`Transformed: ${newData.transactions.length} transactions, ${newData.customers.length} customers, and ${newData.services.length} services.`);
        return newData;
    }


    async function confirmTransactionalReset() {
        const r = await Swal.fire({title:'Reset Sales Data?',text:'This will delete ALL sales and reset OR number.',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',confirmButtonText:'Yes, Reset Sales'});
        if(r.isConfirmed){ showLoading(true); const snap = await db.collection(COLLECTIONS.TRANSACTIONS).get(); const batch=db.batch(); snap.docs.forEach(d => batch.delete(d.ref)); batch.set(db.collection(COLLECTIONS.CONFIG).doc('orCounter'), {value:0}); await batch.commit(); showLoading(false); Swal.fire('Reset Complete','Sales data cleared.','success').then(()=>location.reload()); }
    }

    async function confirmMasterReset() {
        const r = await Swal.fire({title:'FACTORY RESET?',text:'This deletes EVERYTHING from the cloud.',icon:'error',showCancelButton:true,confirmButtonColor:'#d33',confirmButtonText:'Yes, Delete Everything'});
        if(r.isConfirmed){ showLoading(true); await Promise.all([ 'transactions', 'customers', 'services', 'config', 'machineStatus' ].map(async coll => { const snap = await db.collection(coll).get(); const batch=db.batch(); snap.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); })); showLoading(false); Swal.fire('Factory Reset Complete','All data erased.','success').then(()=>location.reload()); }
    }

    async function sendPickupReadySms(orNumber, customerPhone, customerName) {
        if (!shopSettings.smsEnabled) return;
        if (!shopSettings.smsApiUrl || !shopSettings.smsPickupMessageTemplate) return Swal.fire('SMS Not Configured', 'Please set up SMS API URL and template in Owner Settings.', 'warning');
        if (!customerPhone) return Swal.fire('Error', `Customer phone number is missing for OR# ${orNumber}.`, 'error');

        let formattedPhone = customerPhone.replace(/\D/g, '');
        if (formattedPhone.startsWith('63')) formattedPhone = '0' + formattedPhone.substring(2);
        else if (formattedPhone.length === 10) formattedPhone = '0' + formattedPhone;
        if (formattedPhone.length !== 11 || !formattedPhone.startsWith('09')) return Swal.fire('Invalid Phone Format', `Invalid phone format: ${customerPhone}`, 'error');

        let message = shopSettings.smsPickupMessageTemplate.replace(/\[Customer Name\]/g, customerName).replace(/\[OR Number\]/g, orNumber).replace(/\[Shop Name\]/g, shopSettings.name);
        const { isConfirmed } = await Swal.fire({
            title: 'Send "Ready for Pickup" SMS?', html: `<p>To: <strong>${customerName} (${formattedPhone})</strong></p><p>Message:</p><p class="text-left bg-gray-100 p-3 rounded">${message}</p>`,
            icon: 'question', showCancelButton: true, confirmButtonText: 'Yes, Send SMS', confirmButtonColor: '#8a2be2'
        });
        if (!isConfirmed) return;
        showLoading(true, 'Sending SMS...');
        try {
            const response = await fetch(`${shopSettings.smsApiUrl}n=${formattedPhone}&t=${encodeURIComponent(message)}`);
            if (response.ok) {
                const result = await response.json().catch(() => ({}));
                if (result.status === 'success' || result.success) {
                    Toast.fire({ icon: 'success', title: 'SMS sent successfully!' });
                    await db.collection(COLLECTIONS.TRANSACTIONS).doc(orNumber).update({ smsSent: true });
                } else { Swal.fire('SMS Failed', result.error || 'Failed to send SMS via API.', 'error'); }
            } else { Swal.fire('SMS Failed', `Server responded with status ${response.status}.`, 'error'); }
        } catch (error) { Swal.fire('SMS Error', `An error occurred: ${error.message}.`, 'error'); }
        finally { showLoading(false); }
    }
    
    // ### NEW ### Function to trigger site update via Cloudflare Worker
    async function checkForUpdates() {
        const { isConfirmed } = await Swal.fire({
            title: 'Update Site?',
            text: "This will fetch the latest version of the POS system. The page will reload after triggering the update.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Update Now!'
        });

        if (isConfirmed) {
            showLoading(true, "Sending update signal...");

            // ================== ⚠️ IMPORTANT ⚠️ ==================
            //      Replace these two values below with
            //       YOUR Worker URL and Secret Token
            // ====================================================
            const workerUrl = 'https://pos-update-trigger.your-name.workers.dev'; // <--- ❗ REPLACE THIS
            const secretToken = 'rasthaman123';                   // <--- ❗ REPLACE THIS

            try {
                const response = await fetch(workerUrl, {
                    method: 'POST',
                    headers: {
                        'X-Auth-Token': secretToken
                    }
                });

                if (response.ok) {
                    await Swal.fire({
                        title: 'Update Started!',
                        text: 'The new version is being deployed. The page will reload in 10 seconds to apply the changes.',
                        icon: 'success',
                        timer: 10000,
                        timerProgressBar: true,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    location.reload();
                } else {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
            } catch (error) {
                console.error("Update failed:", error);
                Swal.fire('Error', `Could not trigger the update. Please check the console or try again later. Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
    }

    // --- App Initializer ---
    document.addEventListener('DOMContentLoaded', promptStaffLogin);
  </script>
</body>
</html>
```
